<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - AdsData Platform</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #000000;
      color: #ffffff;
      min-height: 100vh;
      padding: 0;
    }

    .header {
      background-color: #1a1a1a;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 2rem;
      height: 2rem;
      background-color: #b7fa31;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: #000000;
      font-size: 0.875rem;
    }

    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: #ffffff;
    }

    .nav-menu {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .nav-link {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s ease;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }

    .nav-link:hover {
      color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.1);
    }

    .nav-link.active {
      color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.15);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .user-email {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background-color: #b7fa31;
      color: #000000;
    }

    .btn-primary:hover {
      background-color: #a8eb22;
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      background-color: rgba(183, 250, 49, 0.3);
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .btn-danger {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
      background-color: rgba(239, 68, 68, 0.2);
    }

    .card {
      background-color: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    /* Responsive Dashboard Grid System */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .widget {
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1.5rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .widget:hover {
      border-color: rgba(183, 250, 49, 0.2);
      box-shadow: 0 8px 32px rgba(183, 250, 49, 0.1);
      transform: translateY(-2px);
    }

    /* Widget Sizes */
    .widget-full { grid-column: span 12; }
    .widget-half { grid-column: span 6; }
    .widget-third { grid-column: span 4; }
    .widget-quarter { grid-column: span 3; }

    /* Scorecard Widgets */
    .scorecard {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .scorecard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .scorecard-label {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .scorecard-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .scorecard-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #ffffff;
      line-height: 1;
    }

    .scorecard-comparison {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .scorecard-comparison.positive {
      color: #10b981;
    }

    .scorecard-comparison.negative {
      color: #ef4444;
    }

    .scorecard-comparison.neutral {
      color: rgba(255, 255, 255, 0.5);
    }

    .scorecard-trend {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .sparkline {
      height: 40px;
      margin-top: 0.75rem;
      width: 100%;
    }

    .sparkline canvas {
      width: 100% !important;
      height: 40px !important;
    }

    /* Date Range Filter */
    .date-filter-bar {
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1.5rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .date-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .date-preset-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .date-preset-btn {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }

    .date-preset-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
    }

    .date-preset-btn.active {
      background: rgba(183, 250, 49, 0.15);
      border-color: #b7fa31;
      color: #b7fa31;
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .widget-third { grid-column: span 6; }
    }

    @media (max-width: 768px) {
      .widget-half,
      .widget-third,
      .widget-quarter {
        grid-column: span 12;
      }

      .dashboard-grid {
        gap: 1rem;
      }

      .scorecard-value {
        font-size: 2rem;
      }

      .date-preset-buttons {
        width: 100%;
        overflow-x: auto;
      }

      .date-preset-btn {
        white-space: nowrap;
      }
    }

    .card h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .card-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }

    .workspace-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .workspace-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .workspace-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #b7fa31 0%, #8bc34a 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .workspace-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 0.25rem;
    }

    .workspace-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: #ffffff;
    }

    .workspace-selector {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .workspace-selector label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.5);
      white-space: nowrap;
    }

    select {
      min-width: 250px;
      padding: 0.75rem 1rem;
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      color: #ffffff;
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    select:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    select:focus {
      outline: none;
      border-color: #b7fa31;
      box-shadow: 0 0 0 3px rgba(183, 250, 49, 0.1);
    }

    .connection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .connection-card {
      background-color: rgba(255, 255, 255, 0.02);
      border: 2px dashed rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .connection-card:hover {
      border-color: rgba(255, 255, 255, 0.2);
      background-color: rgba(255, 255, 255, 0.03);
    }

    .connection-card.connected {
      border: 2px solid #b7fa31;
      background-color: rgba(183, 250, 49, 0.05);
    }

    .platform-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .platform-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }

    .connection-status {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 1.5rem;
    }

    .connection-status.connected {
      color: #b7fa31;
      font-weight: 600;
    }

    .accounts-list {
      margin-top: 1.5rem;
    }

    .account-item {
      background-color: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .account-info {
      flex: 1;
    }

    .account-name {
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.25rem;
      font-size: 0.9375rem;
    }

    .account-id {
      font-size: 0.8125rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .account-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .account-status {
      display: inline-block;
      padding: 0.375rem 0.875rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .account-status.active {
      background-color: rgba(183, 250, 49, 0.15);
      color: #b7fa31;
    }

    .account-status.inactive {
      background-color: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .alert {
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      margin-bottom: 2rem;
      font-size: 0.875rem;
    }

    .alert-success {
      background-color: rgba(183, 250, 49, 0.1);
      color: #b7fa31;
      border: 1px solid rgba(183, 250, 49, 0.3);
    }

    .alert-error {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .alert-warning {
      background-color: rgba(251, 191, 36, 0.1);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .dashboard-card {
      background-color: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .dashboard-card:hover {
      border-color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.05);
      transform: translateY(-2px);
    }

    .dashboard-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .dashboard-card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }

    .dashboard-card-description {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    .dashboard-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .dashboard-card-date {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
    }

    .dashboard-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-icon {
      padding: 0.5rem;
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-icon:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: #ffffff;
    }

    .btn-icon.danger:hover {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .create-dashboard-card {
      background-color: rgba(183, 250, 49, 0.05);
      border: 2px dashed rgba(183, 250, 49, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    .create-dashboard-card:hover {
      border-color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.1);
    }

    .create-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #b7fa31;
    }

    .create-text {
      font-size: 1rem;
      font-weight: 600;
      color: #b7fa31;
    }

    .ai-generate-card {
      background-color: rgba(147, 51, 234, 0.05);
      border: 2px dashed rgba(147, 51, 234, 0.3);
    }

    .ai-generate-card:hover {
      border-color: #9333ea;
      background-color: rgba(147, 51, 234, 0.1);
    }

    .ai-generate-card .create-icon {
      color: #9333ea;
    }

    .ai-generate-card .create-text {
      color: #9333ea;
    }

    .ai-modal-content {
      max-width: 600px;
    }

    .ai-prompt-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .ai-generating {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    .ai-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(147, 51, 234, 0.3);
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .ai-preview {
      background-color: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .ai-preview h4 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #9333ea;
    }

    .ai-preview-item {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.875rem;
    }

    .ai-preview-item:last-child {
      border-bottom: none;
    }

    .ai-insights {
      margin-top: 1rem;
      padding: 1rem;
      background-color: rgba(147, 51, 234, 0.1);
      border-radius: 0.75rem;
    }

    .ai-insights h4 {
      font-size: 0.875rem;
      color: #9333ea;
      margin-bottom: 0.5rem;
    }

    .ai-insights ul {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.8125rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .ai-insights li {
      margin-bottom: 0.25rem;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ffffff;
    }

    .close-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #ffffff;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      color: #ffffff;
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #b7fa31;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .logo {
        gap: 0.5rem;
      }

      .logo-icon {
        width: 1.75rem;
        height: 1.75rem;
        font-size: 0.75rem;
      }

      .logo-text {
        font-size: 1rem;
      }

      .nav-menu {
        order: 3;
        width: 100%;
        flex-direction: column;
        gap: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }

      .nav-link {
        width: 100%;
        text-align: center;
        padding: 0.625rem 1rem;
      }

      .user-info {
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .user-email {
        font-size: 0.75rem;
      }

      .btn {
        padding: 0.625rem 1rem;
        font-size: 0.8125rem;
      }

      .container {
        padding: 1rem;
      }

      .card {
        padding: 1.25rem;
        margin-bottom: 1.25rem;
        border-radius: 1rem;
      }

      .card h2 {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
      }

      .card-subtitle {
        font-size: 0.8125rem;
        margin-bottom: 1.25rem;
      }

      .workspace-card {
        flex-direction: column;
        gap: 1.25rem;
        align-items: flex-start;
      }

      .workspace-info {
        width: 100%;
      }

      .workspace-selector {
        width: 100%;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      .workspace-selector label {
        font-size: 0.6875rem;
      }

      select {
        width: 100%;
        min-width: auto;
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
      }

      .connection-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .connection-card {
        padding: 1.5rem;
      }

      .platform-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .platform-name {
        font-size: 1rem;
      }

      .connection-status {
        font-size: 0.8125rem;
        margin-bottom: 1rem;
      }

      .account-item {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        align-items: flex-start;
      }

      .account-actions {
        width: 100%;
        flex-direction: column-reverse;
        gap: 0.75rem;
      }

      .account-actions button {
        width: 100%;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .dashboard-card {
        padding: 1.25rem;
      }

      .dashboard-card-title {
        font-size: 1rem;
      }

      .dashboard-card-description {
        font-size: 0.8125rem;
      }

      .dashboard-card-footer {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }

      .create-dashboard-card {
        min-height: 160px;
      }

      .create-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
      }

      .create-text {
        font-size: 0.875rem;
      }

      .modal-content {
        width: 95%;
        padding: 1.5rem;
        border-radius: 1rem;
      }

      .modal-header h3 {
        font-size: 1.25rem;
      }

      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-group label {
        font-size: 0.8125rem;
      }

      .form-group input,
      .form-group textarea {
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
      }

      .modal-footer {
        flex-direction: column-reverse;
        gap: 0.75rem;
      }

      .modal-footer button {
        width: 100%;
      }

      .ai-modal-content {
        max-width: 95%;
      }

      .alert {
        font-size: 0.8125rem;
        padding: 0.875rem 1rem;
        margin-bottom: 1.25rem;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 0.875rem;
      }

      .logo-text {
        font-size: 0.9375rem;
      }

      .container {
        padding: 0.75rem;
      }

      .card {
        padding: 1rem;
      }

      .card h2 {
        font-size: 1.125rem;
      }

      .workspace-icon {
        width: 40px;
        height: 40px;
        font-size: 1.125rem;
      }

      .workspace-name {
        font-size: 1rem;
      }

      .connection-card {
        padding: 1.25rem;
      }

      .btn {
        padding: 0.5625rem 0.875rem;
      }

      .modal-content {
        padding: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <div class="logo-icon">AD</div>
      <div class="logo-text">AdsData</div>
    </div>
    <nav class="nav-menu">
      <a href="/dashboard" class="nav-link active">Dashboard</a>
      <a href="/custom-data.html" class="nav-link">üìä Custom Data</a>
    </nav>
    <div class="user-info">
      <span class="user-email" id="userEmail">Loading...</span>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="alertContainer"></div>

    <div class="card">
      <div class="workspace-card">
        <div class="workspace-info">
          <div class="workspace-icon">üè¢</div>
          <div>
            <div class="workspace-label">Current Workspace</div>
            <div class="workspace-name" id="currentWorkspaceName">Loading...</div>
          </div>
        </div>
        <div class="workspace-selector">
          <label for="workspaceSelect">Switch workspace</label>
          <select id="workspaceSelect" onchange="handleWorkspaceChange()">
            <option value="">Loading workspaces...</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Date Range Filter (hidden until accounts are connected) -->
    <div class="date-filter-bar" id="dateFilterBar" style="display: none;">
      <div class="date-controls">
        <label style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Date Range:</label>
        <div class="date-preset-buttons">
          <button class="date-preset-btn" onclick="setDateRange('today')">Today</button>
          <button class="date-preset-btn active" onclick="setDateRange('last7days')">Last 7 Days</button>
          <button class="date-preset-btn" onclick="setDateRange('last30days')">Last 30 Days</button>
          <button class="date-preset-btn" onclick="setDateRange('thismonth')">This Month</button>
          <button class="date-preset-btn" onclick="setDateRange('lastmonth')">Last Month</button>
        </div>
      </div>
      <div class="date-controls">
        <label style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Compare to:</label>
        <select id="comparisonPeriod" style="min-width: 180px;">
          <option value="previous">Previous Period</option>
          <option value="lastmonth">Same Period Last Month</option>
          <option value="lastyear">Same Period Last Year</option>
        </select>
      </div>
    </div>

    <!-- No Data Message (shown when no connected accounts or no data) -->
    <div class="card" id="noDataMessage">
      <div style="text-align: center; padding: 3rem 2rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üìä</div>
        <h2 style="margin-bottom: 1rem;">No Analytics Data Available</h2>
        <p style="color: rgba(255, 255, 255, 0.6); font-size: 1rem; margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
          To view your advertising performance metrics, please connect your advertising accounts below and ensure they have proper tracking set up.
        </p>
        <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
          <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.875rem;">‚úì Connect Meta Ads</span>
          <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.875rem;">‚úì Connect Google Ads</span>
          <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.875rem;">‚úì Set up conversion tracking</span>
        </div>
      </div>
    </div>

    <!-- KPI Scorecard Grid (hidden until accounts are connected) -->
    <div class="dashboard-grid" id="kpiGrid" style="display: none;">
      <!-- Total Spend Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Ad Spend</span>
          </div>
          <div class="scorecard-value" id="totalSpend">$0.00</div>
          <div class="scorecard-comparison neutral" id="spendComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="spendSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Total Revenue Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Revenue</span>
          </div>
          <div class="scorecard-value" id="totalRevenue">$0.00</div>
          <div class="scorecard-comparison neutral" id="revenueComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="revenueSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- ROAS Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">ROAS</span>
          </div>
          <div class="scorecard-value" id="roas">0.00</div>
          <div class="scorecard-comparison neutral" id="roasComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="roasSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Conversions Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Conversions</span>
          </div>
          <div class="scorecard-value" id="conversions">0</div>
          <div class="scorecard-comparison neutral" id="conversionsComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="conversionsSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Clicks Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Clicks</span>
          </div>
          <div class="scorecard-value" id="clicks">0</div>
          <div class="scorecard-comparison neutral" id="clicksComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="clicksSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Impressions Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Impressions</span>
          </div>
          <div class="scorecard-value" id="impressions">Loading...</div>
          <div class="scorecard-comparison neutral" id="impressionsComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="impressionsSparkline"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Connect Your Accounts</h2>
      <p class="card-subtitle">Link your advertising accounts to view all your data in one place. Choose a platform to get started.</p>
      <p class="card-subtitle" style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">If Connect does nothing or shows an error, a workspace may not be selected above, or OAuth may need to be configured in Heroku (META_APP_ID, GOOGLE_CLIENT_ID, etc.) and in the provider‚Äôs developer console.</p>

      <div class="connection-grid">
        <!-- Meta Ads Connection -->
        <div class="connection-card" id="metaCard">
          <div class="platform-icon">üìò</div>
          <div class="platform-name">Meta Ads</div>
          <div class="connection-status" id="metaStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectMeta()" id="metaConnectBtn">Connect Meta Ads</button>
        </div>

        <!-- Google Ads Connection -->
        <div class="connection-card" id="googleCard">
          <div class="platform-icon">üîç</div>
          <div class="platform-name">Google Ads</div>
          <div class="connection-status" id="googleStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectGoogle()" id="googleConnectBtn">Connect Google Ads</button>
        </div>

        <!-- Google Search Console Connection -->
        <div class="connection-card" id="searchConsoleCard">
          <div class="platform-icon">üîé</div>
          <div class="platform-name">Search Console</div>
          <div class="connection-status" id="searchConsoleStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectSearchConsole()" id="searchConsoleConnectBtn">Connect Search Console</button>
        </div>

        <!-- Custom Data Upload -->
        <div class="connection-card" style="background: linear-gradient(135deg, rgba(103, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(103, 126, 234, 0.3);">
          <div class="platform-icon">üìä</div>
          <div class="platform-name">Custom Data</div>
          <div class="connection-status" style="color: #b7fa31;">Import Excel/CSV</div>
          <button class="btn btn-primary" onclick="window.location.href='/custom-data.html'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Upload Data</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Connected Accounts</h2>
      <div id="accountsList">
        <div class="loading">Loading accounts...</div>
      </div>
    </div>

    <div class="card">
      <h2>My Dashboards</h2>
      <p class="card-subtitle">Create custom dashboards with the metrics you want to track. Build manually or use AI to generate automatically.</p>
      <div id="dashboardsList">
        <div class="loading">Loading dashboards...</div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Dashboard Modal -->
  <div id="dashboardModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Create New Dashboard</h3>
        <button class="close-btn" onclick="closeDashboardModal()">&times;</button>
      </div>
      <form id="dashboardForm" onsubmit="saveDashboard(event)">
        <div class="form-group">
          <label for="dashboardName">Dashboard Name *</label>
          <input type="text" id="dashboardName" required placeholder="e.g., Q4 Performance Dashboard">
        </div>
        <div class="form-group">
          <label for="dashboardDescription">Description</label>
          <textarea id="dashboardDescription" placeholder="Describe what this dashboard will track..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeDashboardModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Dashboard</button>
        </div>
      </form>
    </div>
  </div>

  <!-- AI Dashboard Generation Modal -->
  <div id="aiModal" class="modal">
    <div class="modal-content ai-modal-content">
      <div class="modal-header">
        <h3>Generate Dashboard with AI</h3>
        <button class="close-btn" onclick="closeAIModal()">&times;</button>
      </div>
      <div id="aiFormSection">
        <div class="form-group">
          <label for="aiAdAccount">Select Ad Account</label>
          <select id="aiAdAccount" class="form-control" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
            <option value="">Loading accounts...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="aiPrompt">Describe your dashboard</label>
          <textarea id="aiPrompt" class="ai-prompt-textarea" placeholder="e.g., Create a dashboard to track e-commerce performance with focus on ROAS, conversion costs, and daily spend trends. Include comparison charts and KPI cards for key metrics."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeAIModal()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="generateAIDashboard()" style="background-color: #9333ea;">Generate with AI</button>
        </div>
      </div>
      <div id="aiGenerating" class="ai-generating" style="display: none;">
        <div class="ai-spinner"></div>
        <div>Generating your dashboard...</div>
        <div style="font-size: 0.875rem; color: rgba(255,255,255,0.5); margin-top: 0.5rem;">This may take a few seconds</div>
      </div>
      <div id="aiPreviewSection" style="display: none;">
        <div class="ai-preview">
          <h4 id="aiPreviewName">Dashboard Name</h4>
          <div id="aiPreviewDescription" style="font-size: 0.875rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem;"></div>
          <div id="aiPreviewWidgets"></div>
        </div>
        <div id="aiInsights" class="ai-insights" style="display: none;">
          <h4>AI Insights</h4>
          <ul id="aiInsightsList"></ul>
        </div>
        <div class="modal-footer" style="margin-top: 1rem;">
          <button type="button" class="btn btn-secondary" onclick="resetAIModal()">Try Again</button>
          <button type="button" class="btn btn-primary" onclick="createAIDashboard()" style="background-color: #9333ea;">Create Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let workspaces = [];
    let selectedWorkspaceId = null;
    let aiGeneratedConfig = null;
    let currentDateRange = 'last7days';
    let currentComparison = 'previous';

    // Check for OAuth callback messages
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const oauthStatus = urlParams.get('oauth');
      const platform = urlParams.get('platform');
      const message = urlParams.get('message');

      if (oauthStatus === 'success') {
        showAlert(`Successfully connected ${platform} account!`, 'success');
        // Clean URL
        window.history.replaceState({}, document.title, '/dashboard');
        loadAccounts();
      } else if (oauthStatus === 'error') {
        showAlert(`Failed to connect account: ${message || 'Unknown error'}`, 'error');
        window.history.replaceState({}, document.title, '/dashboard');
      }

      loadUser();
    });

    async function loadUser() {
      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'include'
        });

        if (!response.ok) {
          window.location.href = '/admin/login';
          return;
        }

        const data = await response.json();
        currentUser = data.user;
        document.getElementById('userEmail').textContent = currentUser.email;

        // Load workspaces
        await loadWorkspaces();
      } catch (error) {
        console.error('Error loading user:', error);
        window.location.href = '/admin/login';
      }
    }

    async function loadWorkspaces() {
      try {
        const response = await fetch('/api/workspaces', {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to load workspaces');
        }

        const data = await response.json();
        workspaces = data.data || [];

        const select = document.getElementById('workspaceSelect');
        select.innerHTML = '';

        if (workspaces.length === 0) {
          select.innerHTML = '<option value="">No workspaces available</option>';
          return;
        }

        workspaces.forEach(workspace => {
          const option = document.createElement('option');
          option.value = workspace.id;
          option.textContent = workspace.name;
          select.appendChild(option);
        });

        // Select first workspace by default
        selectedWorkspaceId = workspaces[0].id;
        select.value = selectedWorkspaceId;
        localStorage.setItem('selectedWorkspaceId', selectedWorkspaceId);
        document.getElementById('currentWorkspaceName').textContent = workspaces[0].name;

        await loadAccounts();
        await loadDashboards();
      } catch (error) {
        console.error('Error loading workspaces:', error);
        showAlert('Failed to load workspaces', 'error');
      }
    }

    async function handleWorkspaceChange() {
      const select = document.getElementById('workspaceSelect');
      selectedWorkspaceId = select.value;
      localStorage.setItem('selectedWorkspaceId', selectedWorkspaceId);

      // Update workspace name display
      const selectedWorkspace = workspaces.find(w => w.id === selectedWorkspaceId);
      if (selectedWorkspace) {
        document.getElementById('currentWorkspaceName').textContent = selectedWorkspace.name;
      }

      await loadAccounts();
      await loadDashboards();
      await loadKPIData();
    }

    // Date Range Functions
    function setDateRange(range) {
      currentDateRange = range;

      // Update button states
      document.querySelectorAll('.date-preset-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Reload KPI data
      loadKPIData();
    }

    async function loadKPIData() {
      if (!selectedWorkspaceId) return;

      try {
        // Calculate date range
        const { startDate, endDate } = getDateRangeFromPreset(currentDateRange);

        // Fetch metrics from unified endpoint
        const response = await fetch(`/api/unified/metrics?workspaceId=${selectedWorkspaceId}&startDate=${startDate}&endDate=${endDate}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          console.error('Failed to load KPI data');
          // Still update cards with empty data to show zeros
          updateKPICards([]);
          return;
        }

        const data = await response.json();

        // Always update KPI cards (will show zeros if no data)
        updateKPICards(data.metrics || []);
      } catch (error) {
        console.error('Error loading KPI data:', error);
        // Show zeros on error
        updateKPICards([]);
      }
    }

    function getDateRangeFromPreset(preset) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let startDate, endDate;

      switch (preset) {
        case 'today':
          startDate = new Date(today);
          endDate = new Date(today);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last7days':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 7);
          endDate = new Date(today);
          break;
        case 'last30days':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 30);
          endDate = new Date(today);
          break;
        case 'thismonth':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today);
          break;
        case 'lastmonth':
          startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          endDate = new Date(today.getFullYear(), today.getMonth(), 0);
          break;
        default:
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 7);
          endDate = new Date(today);
      }

      return {
        startDate: startDate.toISOString().split('T')[0],
        endDate: endDate.toISOString().split('T')[0]
      };
    }

    // Store sparkline chart instances
    const sparklineCharts = {};

    function updateKPICards(metrics) {
      // Check if we have any meaningful data
      const hasData = metrics && metrics.length > 0;

      if (!hasData) {
        // Show no data message, hide KPI grid and date filter
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('kpiGrid').style.display = 'none';
        document.getElementById('dateFilterBar').style.display = 'none';
        return;
      }

      // Aggregate metrics across all platforms
      let totalSpend = 0;
      let totalRevenue = 0;
      let totalConversions = 0;
      let totalClicks = 0;
      let totalImpressions = 0;

      // Group metrics by date for sparklines
      const dailyData = {};

      metrics.forEach(metric => {
        const date = metric.date || metric.created_at?.split('T')[0] || new Date().toISOString().split('T')[0];

        if (!dailyData[date]) {
          dailyData[date] = { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0 };
        }

        dailyData[date].spend += parseFloat(metric.spend || 0);
        dailyData[date].revenue += parseFloat(metric.revenue || 0);
        dailyData[date].conversions += parseInt(metric.conversions || 0);
        dailyData[date].clicks += parseInt(metric.clicks || 0);
        dailyData[date].impressions += parseInt(metric.impressions || 0);

        totalSpend += parseFloat(metric.spend || 0);
        totalRevenue += parseFloat(metric.revenue || 0);
        totalConversions += parseInt(metric.conversions || 0);
        totalClicks += parseInt(metric.clicks || 0);
        totalImpressions += parseInt(metric.impressions || 0);
      });

      // Check if all values are zero (no real data)
      const hasRealData = totalSpend > 0 || totalRevenue > 0 || totalConversions > 0 || totalClicks > 0 || totalImpressions > 0;

      if (!hasRealData) {
        // Show no data message, hide KPI grid and date filter
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('kpiGrid').style.display = 'none';
        document.getElementById('dateFilterBar').style.display = 'none';
        return;
      }

      // Hide no data message, show KPI grid and date filter
      document.getElementById('noDataMessage').style.display = 'none';
      document.getElementById('kpiGrid').style.display = 'grid';
      document.getElementById('dateFilterBar').style.display = 'flex';

      const roas = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;

      // Update scorecard values
      document.getElementById('totalSpend').textContent = formatCurrency(totalSpend);
      document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('roas').textContent = roas.toFixed(2) + 'x'; // Show as multiplier, not currency
      document.getElementById('conversions').textContent = formatNumber(totalConversions);
      document.getElementById('clicks').textContent = formatNumber(totalClicks);
      document.getElementById('impressions').textContent = formatNumber(totalImpressions);

      // Prepare sparkline data
      const dates = Object.keys(dailyData).sort();
      const spendData = dates.map(date => dailyData[date].spend);
      const revenueData = dates.map(date => dailyData[date].revenue);
      const roasData = dates.map(date => {
        const s = dailyData[date].spend;
        const r = dailyData[date].revenue;
        return s > 0 ? r / s : 0;
      });
      const conversionsData = dates.map(date => dailyData[date].conversions);
      const clicksData = dates.map(date => dailyData[date].clicks);
      const impressionsData = dates.map(date => dailyData[date].impressions);

      // Create/update sparklines only if we have date data
      if (dates.length > 0) {
        createSparkline('spendSparkline', spendData);
        createSparkline('revenueSparkline', revenueData);
        createSparkline('roasSparkline', roasData);
        createSparkline('conversionsSparkline', conversionsData);
        createSparkline('clicksSparkline', clicksData);
        createSparkline('impressionsSparkline', impressionsData);
      }

      // Calculate comparison with previous period (mock data for now)
      // TODO: Calculate real comparison when we have previous period data
      updateComparison('spendComparison', 0);
      updateComparison('revenueComparison', 0);
      updateComparison('roasComparison', 0);
      updateComparison('conversionsComparison', 0);
      updateComparison('clicksComparison', 0);
      updateComparison('impressionsComparison', 0);
    }

    function createSparkline(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (sparklineCharts[canvasId]) {
        sparklineCharts[canvasId].destroy();
      }

      // Create new sparkline chart
      sparklineCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map((_, i) => i),
          datasets: [{
            data: data,
            borderColor: '#b7fa31',
            backgroundColor: 'rgba(183, 250, 49, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          },
          scales: {
            x: { display: false },
            y: { display: false }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    }

    function updateComparison(elementId, percentage) {
      const element = document.getElementById(elementId);

      if (percentage === 0) {
        element.className = 'scorecard-comparison neutral';
        element.innerHTML = `<span>‚Äî vs previous period</span>`;
        return;
      }

      const isPositive = percentage > 0;
      const arrow = isPositive ? '‚Üë' : '‚Üì';
      const sign = isPositive ? '+' : '';

      element.className = `scorecard-comparison ${isPositive ? 'positive' : 'negative'}`;
      element.innerHTML = `<span>${arrow} ${sign}${Math.abs(percentage).toFixed(1)}% vs previous period</span>`;
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }

    function formatNumber(value) {
      return new Intl.NumberFormat('en-US').format(value);
    }

    async function loadAccounts() {
      if (!selectedWorkspaceId) {
        document.getElementById('accountsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÅ</div><div>Please select a workspace</div></div>';
        return;
      }

      try {
        const response = await fetch(`/api/oauth/accounts/${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to load accounts');
        }

        const data = await response.json();
        const accounts = data.data || [];

        const accountsList = document.getElementById('accountsList');

        if (accounts.length === 0) {
          accountsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîå</div><div>No connected accounts. Connect your first ad account above!</div></div>';
          return;
        }

        let htmlContent = accounts.map(account => `
          <div class="account-item">
            <div class="account-info">
              <div class="account-name">${account.platform.toUpperCase()}: ${account.account_name}</div>
              <div class="account-id">Account ID: ${account.account_id}</div>
            </div>
            <div class="account-actions">
              <span class="account-status ${account.status}">${account.status}</span>
              <button class="btn btn-danger" onclick="disconnectAccount('${account.id}')">Disconnect</button>
            </div>
          </div>
        `).join('');

        // Load custom data sources
        try {
          const customDataResponse = await fetch(`/api/workspaces/${selectedWorkspaceId}/custom-data/sources`, {
            credentials: 'include'
          });

          if (customDataResponse.ok) {
            const customData = await customDataResponse.json();
            const sources = customData.data || customData.sources || [];

            if (sources.length > 0) {
              htmlContent += sources.map(source => `
                <div class="account-item" style="background: linear-gradient(135deg, rgba(103, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-left: 3px solid #667eea;">
                  <div class="account-info">
                    <div class="account-name">üìä CUSTOM DATA: ${source.source_name}</div>
                    <div class="account-id">Type: ${source.source_type.toUpperCase()} | Rows: ${source.row_count || 0}</div>
                  </div>
                  <div class="account-actions">
                    <span class="account-status connected" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">imported</span>
                    <button class="btn btn-danger" onclick="deleteCustomData('${source.id}')">Delete</button>
                  </div>
                </div>
              `).join('');
            }
          }
        } catch (error) {
          console.error('Error loading custom data sources:', error);
        }

        accountsList.innerHTML = htmlContent;

        // Update Meta status
        const metaAccounts = accounts.filter(a => a.platform === 'meta');
        if (metaAccounts.length > 0) {
          document.getElementById('metaStatus').textContent = `Connected (${metaAccounts.length} account${metaAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('metaStatus').classList.add('connected');
          document.getElementById('metaCard').classList.add('connected');
          document.getElementById('metaConnectBtn').textContent = 'Reconnect';
        }

        // Update Google Ads status
        const googleAccounts = accounts.filter(a => a.platform === 'google');
        if (googleAccounts.length > 0) {
          document.getElementById('googleStatus').textContent = `Connected (${googleAccounts.length} account${googleAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('googleStatus').classList.add('connected');
          document.getElementById('googleCard').classList.add('connected');
          document.getElementById('googleConnectBtn').textContent = 'Reconnect';
        }

        // Update Search Console status
        const searchConsoleAccounts = accounts.filter(a => a.platform === 'search_console');
        if (searchConsoleAccounts.length > 0) {
          document.getElementById('searchConsoleStatus').textContent = `Connected (${searchConsoleAccounts.length} property${searchConsoleAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('searchConsoleStatus').classList.add('connected');
          document.getElementById('searchConsoleCard').classList.add('connected');
          document.getElementById('searchConsoleConnectBtn').textContent = 'Reconnect';
        }
      } catch (error) {
        console.error('Error loading accounts:', error);
        document.getElementById('accountsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Failed to load accounts</div></div>';
      }
    }

    async function connectMeta() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/meta?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        // Redirect to Meta OAuth
        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting Meta:', error);
        showAlert(error.message, 'error');
      }
    }

    async function connectGoogle() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/google?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        // Redirect to Google OAuth
        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting Google Ads:', error);
        showAlert(error.message, 'error');
      }
    }

    async function connectSearchConsole() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/search-console?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        // Redirect to Search Console OAuth
        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting Search Console:', error);
        showAlert(error.message, 'error');
      }
    }

    async function disconnectAccount(accountId) {
      if (!confirm('Are you sure you want to disconnect this account?')) {
        return;
      }

      try {
        const response = await fetch(`/api/oauth/accounts/${accountId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to disconnect account');
        }

        showAlert('Account disconnected successfully', 'success');
        await loadAccounts();
      } catch (error) {
        console.error('Error disconnecting account:', error);
        showAlert('Failed to disconnect account', 'error');
      }
    }

    async function deleteCustomData(sourceId) {
      if (!confirm('Are you sure you want to delete this custom data source? All data will be permanently removed.')) {
        return;
      }

      try {
        const response = await fetch(`/api/workspaces/${selectedWorkspaceId}/custom-data/sources/${sourceId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to delete custom data source');
        }

        showAlert('Custom data source deleted successfully', 'success');
        await loadAccounts();
      } catch (error) {
        console.error('Error deleting custom data source:', error);
        showAlert('Failed to delete custom data source', 'error');
      }
    }

    // Dashboard management
    let dashboards = [];
    let currentDashboardId = null;

    async function loadDashboards() {
      if (!selectedWorkspaceId) {
        document.getElementById('dashboardsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>Please select a workspace to view dashboards</div></div>';
        return;
      }

      try {
        const response = await fetch(`/api/dashboards/workspace/${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to load dashboards');
        }

        const result = await response.json();
        dashboards = result.data;

        renderDashboards();
      } catch (error) {
        console.error('Error loading dashboards:', error);
        document.getElementById('dashboardsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Failed to load dashboards</div></div>';
      }
    }

    function renderDashboards() {
      const container = document.getElementById('dashboardsList');

      if (dashboards.length === 0) {
        container.innerHTML = `
          <div class="dashboard-grid">
            <div class="dashboard-card create-dashboard-card ai-generate-card" onclick="openAIModal()">
              <div class="create-icon">AI</div>
              <div class="create-text">Generate with AI</div>
            </div>
            <div class="dashboard-card create-dashboard-card" onclick="openCreateDashboardModal()">
              <div class="create-icon">+</div>
              <div class="create-text">Create Your First Dashboard</div>
            </div>
          </div>
        `;
        return;
      }

      const dashboardsHTML = dashboards.map(dashboard => {
        const date = new Date(dashboard.created_at).toLocaleDateString();
        return `
          <div class="dashboard-card" onclick="viewDashboard('${dashboard.id}')">
            <div class="dashboard-card-header">
              <div>
                <div class="dashboard-card-title">${dashboard.name}</div>
                <div class="dashboard-card-description">${dashboard.description || 'No description'}</div>
              </div>
            </div>
            <div class="dashboard-card-footer">
              <div class="dashboard-card-date">Created ${date}</div>
              <div class="dashboard-actions" onclick="event.stopPropagation()">
                <button class="btn-icon" onclick="editDashboard('${dashboard.id}')" title="Edit">
                  ‚úèÔ∏è
                </button>
                <button class="btn-icon danger" onclick="deleteDashboard('${dashboard.id}')" title="Delete">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="dashboard-grid">
          ${dashboardsHTML}
          <div class="dashboard-card create-dashboard-card ai-generate-card" onclick="openAIModal()">
            <div class="create-icon">AI</div>
            <div class="create-text">Generate with AI</div>
          </div>
          <div class="dashboard-card create-dashboard-card" onclick="openCreateDashboardModal()">
            <div class="create-icon">+</div>
            <div class="create-text">Create New Dashboard</div>
          </div>
        </div>
      `;
    }

    function openCreateDashboardModal() {
      currentDashboardId = null;
      document.getElementById('modalTitle').textContent = 'Create New Dashboard';
      document.getElementById('dashboardName').value = '';
      document.getElementById('dashboardDescription').value = '';
      document.getElementById('dashboardModal').classList.add('show');
    }

    function editDashboard(dashboardId) {
      const dashboard = dashboards.find(d => d.id === dashboardId);
      if (!dashboard) return;

      currentDashboardId = dashboardId;
      document.getElementById('modalTitle').textContent = 'Edit Dashboard';
      document.getElementById('dashboardName').value = dashboard.name;
      document.getElementById('dashboardDescription').value = dashboard.description || '';
      document.getElementById('dashboardModal').classList.add('show');
    }

    function closeDashboardModal() {
      document.getElementById('dashboardModal').classList.remove('show');
      currentDashboardId = null;
    }

    async function saveDashboard(event) {
      event.preventDefault();

      const name = document.getElementById('dashboardName').value;
      const description = document.getElementById('dashboardDescription').value;

      try {
        const url = currentDashboardId
          ? `/api/dashboards/${currentDashboardId}`
          : '/api/dashboards';

        const method = currentDashboardId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            name,
            description,
            workspaceId: selectedWorkspaceId,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to save dashboard');
        }

        showAlert(currentDashboardId ? 'Dashboard updated successfully' : 'Dashboard created successfully', 'success');
        closeDashboardModal();
        await loadDashboards();
      } catch (error) {
        console.error('Error saving dashboard:', error);
        showAlert(error.message, 'error');
      }
    }

    async function deleteDashboard(dashboardId) {
      if (!confirm('Are you sure you want to delete this dashboard? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/dashboards/${dashboardId}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (!response.ok) {
          throw new Error('Failed to delete dashboard');
        }

        showAlert('Dashboard deleted successfully', 'success');
        await loadDashboards();
      } catch (error) {
        console.error('Error deleting dashboard:', error);
        showAlert('Failed to delete dashboard', 'error');
      }
    }

    function viewDashboard(dashboardId) {
      // Navigate to dashboard viewer
      window.location.href = `/dashboard-viewer?id=${dashboardId}`;
    }

    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // AI Dashboard Generation Functions
    async function openAIModal() {
      resetAIModal();
      document.getElementById('aiModal').classList.add('show');

      // Populate ad accounts dropdown
      const select = document.getElementById('aiAdAccount');
      select.innerHTML = '<option value="">Loading accounts...</option>';

      try {
        const response = await fetch(`/api/oauth/accounts/${selectedWorkspaceId}`, {
          credentials: 'include'
        });
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          select.innerHTML = result.data.map(acc =>
            `<option value="${acc.id}">${acc.account_name} (${acc.platform})</option>`
          ).join('');
        } else {
          select.innerHTML = '<option value="">No accounts connected</option>';
        }
      } catch (error) {
        select.innerHTML = '<option value="">Error loading accounts</option>';
      }
    }

    function closeAIModal() {
      document.getElementById('aiModal').classList.remove('show');
      resetAIModal();
    }

    function resetAIModal() {
      document.getElementById('aiFormSection').style.display = 'block';
      document.getElementById('aiGenerating').style.display = 'none';
      document.getElementById('aiPreviewSection').style.display = 'none';
      document.getElementById('aiPrompt').value = '';
      aiGeneratedConfig = null;
    }

    async function generateAIDashboard() {
      const prompt = document.getElementById('aiPrompt').value.trim();
      const adAccountId = document.getElementById('aiAdAccount').value;

      if (!adAccountId) {
        showAlert('Please select an ad account', 'error');
        return;
      }

      if (!prompt) {
        showAlert('Please describe what kind of dashboard you want to create', 'error');
        return;
      }

      // Show loading state
      document.getElementById('aiFormSection').style.display = 'none';
      document.getElementById('aiGenerating').style.display = 'flex';

      try {
        const response = await fetch('/api/dashboards/ai/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            prompt,
            workspaceId: selectedWorkspaceId,
            adAccountId,
            createDashboard: false,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to generate dashboard');
        }

        const result = await response.json();
        aiGeneratedConfig = result.data.config;

        // Show preview
        document.getElementById('aiGenerating').style.display = 'none';
        document.getElementById('aiPreviewSection').style.display = 'block';

        // Populate preview
        document.getElementById('aiPreviewName').textContent = aiGeneratedConfig.name;
        document.getElementById('aiPreviewDescription').textContent = aiGeneratedConfig.description;

        // Show widgets
        const widgetsHTML = aiGeneratedConfig.widgets.map(w => `
          <div class="ai-preview-item">
            <strong>${w.title}</strong> (${w.widgetType})
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">Metric: ${w.metric}</div>
          </div>
        `).join('');
        document.getElementById('aiPreviewWidgets').innerHTML = widgetsHTML;

        // Show insights if available
        if (aiGeneratedConfig.insights && aiGeneratedConfig.insights.length > 0) {
          document.getElementById('aiInsights').style.display = 'block';
          const insightsHTML = aiGeneratedConfig.insights.map(i => `<li>${i}</li>`).join('');
          document.getElementById('aiInsightsList').innerHTML = insightsHTML;
        }

      } catch (error) {
        console.error('AI generation error:', error);
        showAlert(error.message, 'error');
        resetAIModal();
      }
    }

    async function createAIDashboard() {
      if (!aiGeneratedConfig) {
        showAlert('No dashboard configuration available', 'error');
        return;
      }

      // Get buttons from the preview section specifically
      const previewSection = document.getElementById('aiPreviewSection');
      const createButton = previewSection.querySelector('.btn-primary');
      const tryAgainButton = previewSection.querySelector('.btn-secondary');
      const originalText = createButton.innerHTML;

      try {
        // Disable buttons and show loading state
        createButton.disabled = true;
        tryAgainButton.disabled = true;
        createButton.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 0.5rem;"><svg style="animation: spin 1s linear infinite; width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="3" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg>Creating Dashboard...</span>';

        const prompt = document.getElementById('aiPrompt').value.trim();
        const adAccountId = document.getElementById('aiAdAccount').value;

        const response = await fetch('/api/dashboards/ai/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            prompt,
            workspaceId: selectedWorkspaceId,
            adAccountId,
            createDashboard: true,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to create dashboard');
        }

        const result = await response.json();

        showAlert('AI-generated dashboard created successfully!', 'success');
        closeAIModal();
        await loadDashboards();

        // Navigate to the new dashboard
        if (result.data.dashboard && result.data.dashboard.id) {
          window.location.href = `/dashboard-viewer?id=${result.data.dashboard.id}`;
        }

      } catch (error) {
        console.error('Error creating AI dashboard:', error);
        showAlert(error.message, 'error');

        // Restore button state on error
        createButton.disabled = false;
        tryAgainButton.disabled = false;
        createButton.innerHTML = originalText;
      }
    }

    async function logout() {
      // Get token before clearing
      const token = localStorage.getItem('token');

      // Clear localStorage FIRST to prevent race conditions
      localStorage.removeItem('token');
      localStorage.removeItem('user');

      try {
        // Call logout API to clear server-side cookie
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
      } catch (error) {
        console.error('Logout API error:', error);
      }

      // Redirect with logout parameter to skip auth check
      window.location.href = '/admin/login?logout=true';
    }
  </script>
</body>
</html>
