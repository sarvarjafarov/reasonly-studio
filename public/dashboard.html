<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Reasonly Studio</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #000000;
      color: #ffffff;
      min-height: 100vh;
      padding: 0;
    }

    .header {
      background-color: #1a1a1a;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
    }

    .logo img {
      height: 2.5rem;
      width: auto;
    }

    .nav-menu {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .nav-link {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: color 0.2s ease;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
    }

    .nav-link:hover {
      color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.1);
    }

    .nav-link.active {
      color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.15);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .user-email {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Question-First Hero Section */
    .question-hero {
      text-align: center;
      padding: 2rem 0 1.5rem;
      margin-bottom: 1.5rem;
    }

    .question-hero h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: #ffffff;
    }

    .question-hero p {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .question-input-container {
      max-width: 700px;
      margin: 0 auto;
      position: relative;
    }

    .question-input {
      width: 100%;
      padding: 1rem 1.25rem;
      padding-right: 120px;
      border: 2px solid rgba(183, 250, 49, 0.3);
      background-color: rgba(255, 255, 255, 0.03);
      color: #ffffff;
      border-radius: 1rem;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
    }

    .question-input:focus {
      outline: none;
      border-color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.05);
    }

    .question-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .question-submit-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      padding: 0.65rem 1.25rem;
      background-color: #b7fa31;
      color: #000000;
      border: none;
      border-radius: 0.65rem;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }

    .question-submit-btn:hover {
      background-color: #a3e626;
    }

    .question-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .question-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-top: 1rem;
    }

    .question-suggestion {
      padding: 0.4rem 0.85rem;
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 999px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .question-suggestion:hover {
      background-color: rgba(183, 250, 49, 0.1);
      border-color: rgba(183, 250, 49, 0.3);
      color: #b7fa31;
    }

    /* Proactive Insights Section */
    .insights-section {
      margin-bottom: 2rem;
    }

    .insights-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .insights-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }

    .insights-header .refresh-btn {
      padding: 0.4rem 0.75rem;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.5);
      border-radius: 0.5rem;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .insight-card {
      background-color: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      padding: 1.25rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .insight-card:hover {
      border-color: rgba(183, 250, 49, 0.2);
      background-color: rgba(183, 250, 49, 0.02);
    }

    .insight-card.alert {
      border-left: 3px solid #f59e0b;
    }

    .insight-card.opportunity {
      border-left: 3px solid #10b981;
    }

    .insight-card.info {
      border-left: 3px solid #3b82f6;
    }

    .insight-icon {
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    .insight-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }

    .insight-detail {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.5;
    }

    .insight-action {
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: #b7fa31;
      font-weight: 500;
    }

    /* Analysis Results Section */
    .analysis-results {
      display: none;
      margin-bottom: 2rem;
    }

    .analysis-results.show {
      display: block;
    }

    .analysis-card {
      background-color: #1a1a1a;
      border: 1px solid rgba(183, 250, 49, 0.2);
      border-radius: 1.25rem;
      overflow: hidden;
    }

    .analysis-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .analysis-question {
      font-size: 1rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.25rem;
    }

    .analysis-meta {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
    }

    .analysis-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.4);
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0.25rem;
    }

    .analysis-body {
      padding: 1.5rem;
    }

    .exec-summary {
      margin-bottom: 1.5rem;
    }

    .exec-headline {
      font-size: 1.1rem;
      font-weight: 600;
      color: #b7fa31;
      margin-bottom: 1rem;
    }

    .exec-section {
      margin-bottom: 1rem;
    }

    .exec-section-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 0.5rem;
    }

    .exec-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .exec-section li {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.8);
      padding: 0.35rem 0;
      padding-left: 1.25rem;
      position: relative;
    }

    .exec-section li::before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: rgba(255, 255, 255, 0.3);
    }

    /* Quick Stats Bar */
    .quick-stats {
      display: flex;
      gap: 1rem;
      padding: 1rem 0;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      overflow-x: auto;
    }

    .quick-stat {
      flex: 0 0 auto;
      min-width: 120px;
      padding: 0.75rem 1rem;
      background-color: rgba(255, 255, 255, 0.02);
      border-radius: 0.75rem;
      text-align: center;
    }

    .quick-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #ffffff;
    }

    .quick-stat-label {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .quick-stat-change {
      font-size: 0.7rem;
      margin-top: 0.25rem;
    }

    .quick-stat-change.positive {
      color: #10b981;
    }

    .quick-stat-change.negative {
      color: #ef4444;
    }

    /* Section Headers */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
    }

    .section-subtitle {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
    }

    /* Collapsible Sections */
    .collapsible-section {
      margin-bottom: 1rem;
    }

    .collapsible-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      background-color: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .collapsible-header:hover {
      background-color: rgba(255, 255, 255, 0.04);
    }

    .collapsible-header h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
    }

    .collapsible-toggle {
      color: rgba(255, 255, 255, 0.4);
      font-size: 0.8rem;
    }

    .collapsible-body {
      display: none;
      padding: 1rem 0;
    }

    .collapsible-section.open .collapsible-body {
      display: block;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background-color: #b7fa31;
      color: #000000;
    }

    .btn-primary:hover {
      background-color: #a8eb22;
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      background-color: rgba(183, 250, 49, 0.3);
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    .btn-danger {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
      background-color: rgba(239, 68, 68, 0.2);
    }

    .card {
      background-color: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1.5rem;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    /* Responsive Dashboard Grid System */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .widget {
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1.5rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .widget:hover {
      border-color: rgba(183, 250, 49, 0.2);
      box-shadow: 0 8px 32px rgba(183, 250, 49, 0.1);
      transform: translateY(-2px);
    }

    /* Widget Sizes */
    .widget-full { grid-column: span 12; }
    .widget-half { grid-column: span 6; }
    .widget-third { grid-column: span 4; }
    .widget-quarter { grid-column: span 3; }

    /* Scorecard Widgets */
    .scorecard {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .scorecard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .scorecard-label {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .scorecard-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .scorecard-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #ffffff;
      line-height: 1;
    }

    .scorecard-comparison {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .scorecard-comparison.positive {
      color: #10b981;
    }

    .scorecard-comparison.negative {
      color: #ef4444;
    }

    .scorecard-comparison.neutral {
      color: rgba(255, 255, 255, 0.5);
    }

    .scorecard-trend {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .sparkline {
      height: 40px;
      margin-top: 0.75rem;
      width: 100%;
    }

    .sparkline canvas {
      width: 100% !important;
      height: 40px !important;
    }

    /* Date Range Filter */
    .date-filter-bar {
      background: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1.5rem;
      padding: 1.5rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.5rem;
      flex-wrap: wrap;
    }

    .date-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .date-preset-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .date-preset-btn {
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }

    .date-preset-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #ffffff;
    }

    .date-preset-btn.active {
      background: rgba(183, 250, 49, 0.15);
      border-color: #b7fa31;
      color: #b7fa31;
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .widget-third { grid-column: span 6; }
    }

    @media (max-width: 768px) {
      .widget-half,
      .widget-third,
      .widget-quarter {
        grid-column: span 12;
      }

      .dashboard-grid {
        gap: 1rem;
      }

      .scorecard-value {
        font-size: 2rem;
      }

      .date-preset-buttons {
        width: 100%;
        overflow-x: auto;
      }

      .date-preset-btn {
        white-space: nowrap;
      }
    }

    .card h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .card-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }

    .workspace-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .workspace-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .workspace-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #b7fa31 0%, #8bc34a 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .workspace-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 0.25rem;
    }

    .workspace-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: #ffffff;
    }

    .workspace-selector {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .workspace-selector label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.5);
      white-space: nowrap;
    }

    select {
      min-width: 250px;
      padding: 0.75rem 1rem;
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      color: #ffffff;
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    select:hover {
      background-color: rgba(255, 255, 255, 0.08);
    }

    select:focus {
      outline: none;
      border-color: #b7fa31;
      box-shadow: 0 0 0 3px rgba(183, 250, 49, 0.1);
    }

    .connection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .connection-card {
      background-color: rgba(255, 255, 255, 0.02);
      border: 2px dashed rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
    }

    .connection-card:hover {
      border-color: rgba(255, 255, 255, 0.2);
      background-color: rgba(255, 255, 255, 0.03);
    }

    .connection-card.connected {
      border: 2px solid #b7fa31;
      background-color: rgba(183, 250, 49, 0.05);
    }

    .platform-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .platform-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }

    .connection-status {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 1.5rem;
    }

    .connection-status.connected {
      color: #b7fa31;
      font-weight: 600;
    }

    .accounts-list {
      margin-top: 1.5rem;
    }

    .account-item {
      background-color: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .account-info {
      flex: 1;
    }

    .account-name {
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.25rem;
      font-size: 0.9375rem;
    }

    .account-id {
      font-size: 0.8125rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .account-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .account-status {
      display: inline-block;
      padding: 0.375rem 0.875rem;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .account-status.active {
      background-color: rgba(183, 250, 49, 0.15);
      color: #b7fa31;
    }

    .account-status.inactive {
      background-color: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .alert {
      padding: 1rem 1.25rem;
      border-radius: 0.75rem;
      margin-bottom: 2rem;
      font-size: 0.875rem;
    }

    .alert-success {
      background-color: rgba(183, 250, 49, 0.1);
      color: #b7fa31;
      border: 1px solid rgba(183, 250, 49, 0.3);
    }

    .alert-error {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .alert-warning {
      background-color: rgba(251, 191, 36, 0.1);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .dashboard-card {
      background-color: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .dashboard-card:hover {
      border-color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.05);
      transform: translateY(-2px);
    }

    .dashboard-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .dashboard-card-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }

    .dashboard-card-description {
      font-size: 0.875rem;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 1rem;
      line-height: 1.4;
    }

    .dashboard-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .dashboard-card-date {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
    }

    .dashboard-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-icon {
      padding: 0.5rem;
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.5rem;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-icon:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: #ffffff;
    }

    .btn-icon.danger:hover {
      background-color: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .create-dashboard-card {
      background-color: rgba(183, 250, 49, 0.05);
      border: 2px dashed rgba(183, 250, 49, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
    }

    .create-dashboard-card:hover {
      border-color: #b7fa31;
      background-color: rgba(183, 250, 49, 0.1);
    }

    .create-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #b7fa31;
    }

    .create-text {
      font-size: 1rem;
      font-weight: 600;
      color: #b7fa31;
    }

    .ai-generate-card {
      background-color: rgba(147, 51, 234, 0.05);
      border: 2px dashed rgba(147, 51, 234, 0.3);
    }

    .ai-generate-card:hover {
      border-color: #9333ea;
      background-color: rgba(147, 51, 234, 0.1);
    }

    .ai-generate-card .create-icon {
      color: #9333ea;
    }

    .ai-generate-card .create-text {
      color: #9333ea;
    }

    .ai-modal-content {
      max-width: 600px;
    }

    .ai-prompt-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .ai-generating {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    .ai-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(147, 51, 234, 0.3);
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .ai-preview {
      background-color: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }

    .ai-preview h4 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #9333ea;
    }

    .ai-preview-item {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 0.875rem;
    }

    .ai-preview-item:last-child {
      border-bottom: none;
    }

    .ai-insights {
      margin-top: 1rem;
      padding: 1rem;
      background-color: rgba(147, 51, 234, 0.1);
      border-radius: 0.75rem;
    }

    .ai-insights h4 {
      font-size: 0.875rem;
      color: #9333ea;
      margin-bottom: 0.5rem;
    }

    .ai-insights ul {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.8125rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .ai-insights li {
      margin-bottom: 0.25rem;
    }

    .analyst-panel {
      border: 1px solid rgba(183, 250, 49, 0.2);
      background-color: rgba(255, 255, 255, 0.02);
      border-radius: 1.2rem;
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .analyst-panel.hidden {
      display: none;
    }

    .analyst-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .analyst-header:hover {
      background-color: rgba(183, 250, 49, 0.05);
    }

    .analyst-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .analyst-header-left h3 {
      font-size: 1.1rem;
      margin: 0;
    }

    .analyst-header-left .badge {
      background-color: rgba(183, 250, 49, 0.15);
      color: #b7fa31;
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .analyst-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.85rem;
    }

    .analyst-toggle svg {
      transition: transform 0.2s ease;
    }

    .analyst-panel.expanded .analyst-toggle svg {
      transform: rotate(180deg);
    }

    .analyst-body {
      padding: 0 1.5rem 1.5rem;
      display: none;
      max-width: 900px;
    }

    .analyst-panel.expanded .analyst-body {
      display: block;
    }

    .analyst-body > p {
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }

    .analyst-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .analyst-grid-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .analyst-grid-full {
      grid-column: 1 / -1;
    }

    .analyst-grid label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 0.4rem;
    }

    .analyst-grid textarea,
    .analyst-grid input,
    .analyst-grid select,
    .analyst-grid-2col textarea,
    .analyst-grid-2col input,
    .analyst-grid-2col select {
      width: 100%;
      padding: 0.65rem 0.875rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background-color: rgba(255, 255, 255, 0.04);
      color: #ffffff;
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      resize: vertical;
    }

    .analyst-grid textarea:focus,
    .analyst-grid input:focus,
    .analyst-grid select:focus,
    .analyst-grid-2col textarea:focus,
    .analyst-grid-2col input:focus,
    .analyst-grid-2col select:focus {
      outline: none;
      border-color: rgba(183, 250, 49, 0.5);
    }

    .analyst-status {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
      margin-left: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .analyst-status.error {
      color: #f87171;
    }

    .analyst-results {
      margin-top: 1.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding-top: 1.25rem;
      display: none;
    }

    .analyst-section {
      margin-bottom: 1rem;
    }

    .analyst-section h4 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      color: #b7fa31;
    }

    .analyst-section ul {
      list-style: disc;
      margin-left: 1.25rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .metric-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }

    .metric-tag {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      background-color: rgba(183, 250, 49, 0.15);
      color: #b7fa31;
      font-size: 0.75rem;
    }

    .analyst-evidence-item {
      background-color: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
    }

    .analyst-details summary {
      cursor: pointer;
      font-weight: 600;
      color: #b7fa31;
      margin-bottom: 0.5rem;
    }

    .analyst-trace {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 0.75rem;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.02);
    }

    .account-item {
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease;
    }

    .account-item.active {
      background-color: rgba(183, 250, 49, 0.08);
      border-color: rgba(183, 250, 49, 0.3);
    }

    .analyst-scope-line {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }

    .analyst-scope-pill {
      font-size: 0.85rem;
      padding: 0.25rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(183, 250, 49, 0.5);
      color: #b7fa31;
    }

    .analyst-warning {
      margin: 0.75rem 0;
      padding: 0.75rem 1rem;
      font-size: 0.8rem;
      color: #fbbf24;
      background-color: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.2);
      border-radius: 0.5rem;
      display: none;
    }

    .trace-list {
      margin-top: 0.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      padding-top: 0.75rem;
    }

    .trace-item {
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: #1a1a1a;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ffffff;
    }

    .close-btn {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #ffffff;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      background-color: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      color: #ffffff;
      font-size: 0.875rem;
      font-family: 'Inter', sans-serif;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #b7fa31;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .logo img {
        height: 2rem;
      }

      .nav-menu {
        order: 3;
        width: 100%;
        flex-direction: column;
        gap: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
      }

      .nav-link {
        width: 100%;
        text-align: center;
        padding: 0.625rem 1rem;
      }

      .user-info {
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .user-email {
        font-size: 0.75rem;
      }

      .btn {
        padding: 0.625rem 1rem;
        font-size: 0.8125rem;
      }

      .container {
        padding: 1rem;
      }

      .card {
        padding: 1.25rem;
        margin-bottom: 1.25rem;
        border-radius: 1rem;
      }

      .card h2 {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
      }

      .card-subtitle {
        font-size: 0.8125rem;
        margin-bottom: 1.25rem;
      }

      .workspace-card {
        flex-direction: column;
        gap: 1.25rem;
        align-items: flex-start;
      }

      .workspace-info {
        width: 100%;
      }

      .workspace-selector {
        width: 100%;
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      .workspace-selector label {
        font-size: 0.6875rem;
      }

      select {
        width: 100%;
        min-width: auto;
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
      }

      .connection-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .connection-card {
        padding: 1.5rem;
      }

      .platform-icon {
        font-size: 2.5rem;
        margin-bottom: 0.75rem;
      }

      .platform-name {
        font-size: 1rem;
      }

      .connection-status {
        font-size: 0.8125rem;
        margin-bottom: 1rem;
      }

      .account-item {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        align-items: flex-start;
      }

      .account-actions {
        width: 100%;
        flex-direction: column-reverse;
        gap: 0.75rem;
      }

      .account-actions button {
        width: 100%;
      }

      .analyst-grid {
        grid-template-columns: 1fr !important;
      }

      .analyst-header-left h3 {
        font-size: 1rem;
      }

      /* Question-first responsive */
      .question-hero h1 {
        font-size: 1.35rem;
      }

      .question-hero p {
        font-size: 0.8rem;
      }

      .question-input {
        padding-right: 1rem;
        font-size: 0.9rem;
      }

      .question-submit-btn {
        position: static;
        transform: none;
        width: 100%;
        margin-top: 0.75rem;
      }

      .question-input-container {
        display: flex;
        flex-direction: column;
      }

      .question-suggestions {
        flex-wrap: wrap;
      }

      .question-suggestion {
        font-size: 0.7rem;
      }

      .insights-grid {
        grid-template-columns: 1fr;
      }

      .quick-stats {
        flex-wrap: nowrap;
        overflow-x: auto;
        padding-bottom: 0.5rem;
      }

      .quick-stat {
        min-width: 100px;
      }

      .quick-stat-value {
        font-size: 1rem;
      }

      .analysis-question {
        font-size: 0.9rem;
      }

      .exec-headline {
        font-size: 1rem;
      }

      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .dashboard-card {
        padding: 1.25rem;
      }

      .dashboard-card-title {
        font-size: 1rem;
      }

      .dashboard-card-description {
        font-size: 0.8125rem;
      }

      .dashboard-card-footer {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }

      .create-dashboard-card {
        min-height: 160px;
      }

      .create-icon {
        font-size: 2rem;
        margin-bottom: 0.75rem;
      }

      .create-text {
        font-size: 0.875rem;
      }

      .modal-content {
        width: 95%;
        padding: 1.5rem;
        border-radius: 1rem;
      }

      .modal-header h3 {
        font-size: 1.25rem;
      }

      .form-group {
        margin-bottom: 1.25rem;
      }

      .form-group label {
        font-size: 0.8125rem;
      }

      .form-group input,
      .form-group textarea {
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
      }

      .modal-footer {
        flex-direction: column-reverse;
        gap: 0.75rem;
      }

      .modal-footer button {
        width: 100%;
      }

      .ai-modal-content {
        max-width: 95%;
      }

      .alert {
        font-size: 0.8125rem;
        padding: 0.875rem 1rem;
        margin-bottom: 1.25rem;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 0.875rem;
      }

      .logo img {
        height: 1.75rem;
      }

      .container {
        padding: 0.75rem;
      }

      .card {
        padding: 1rem;
      }

      .card h2 {
        font-size: 1.125rem;
      }

      .workspace-icon {
        width: 40px;
        height: 40px;
        font-size: 1.125rem;
      }

      .workspace-name {
        font-size: 1rem;
      }

      .connection-card {
        padding: 1.25rem;
      }

      .btn {
        padding: 0.5625rem 0.875rem;
      }

      .modal-content {
        padding: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <img src="/images/reasonlystudio-logo.png" alt="Reasonly Studio">
    </div>
    <nav class="nav-menu">
      <a href="/dashboard" class="nav-link active">Overview</a>
      <a href="/campaigns.html" class="nav-link">Campaigns</a>
      <a href="/custom-data.html" class="nav-link">Custom Data</a>
      <a href="/website-audit.html" class="nav-link">Site Audit</a>
    </nav>
    <div class="user-info">
      <span class="user-email" id="userEmail">Loading...</span>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="alertContainer"></div>

    <!-- QUESTION-FIRST HERO SECTION -->
    <div class="question-hero">
      <h1>What do you want to know about your marketing?</h1>
      <p>Ask a question and let AI analyze your data, find insights, and recommend actions.</p>
      <div class="question-input-container">
        <input
          type="text"
          class="question-input"
          id="heroQuestionInput"
          placeholder="e.g., Why did my ROAS drop last week?"
          onkeypress="if(event.key === 'Enter') submitHeroQuestion()"
        >
        <button class="question-submit-btn" onclick="submitHeroQuestion()" id="heroSubmitBtn">
          Analyze
        </button>
      </div>
      <div class="question-suggestions">
        <span class="question-suggestion" onclick="setQuestionSuggestion('Why did my ROAS change last week?')">Why did ROAS change?</span>
        <span class="question-suggestion" onclick="setQuestionSuggestion('Which campaigns should I scale?')">Which campaigns to scale?</span>
        <span class="question-suggestion" onclick="setQuestionSuggestion('Compare Meta vs Google performance')">Compare platforms</span>
        <span class="question-suggestion" onclick="setQuestionSuggestion('What is causing my CPA to increase?')">Why is CPA increasing?</span>
      </div>
    </div>

    <!-- ANALYSIS RESULTS (shown after query) -->
    <div class="analysis-results" id="analysisResults">
      <div class="analysis-card">
        <div class="analysis-header">
          <div>
            <div class="analysis-question" id="analysisQuestionText">Loading...</div>
            <div class="analysis-meta" id="analysisMeta">Analyzing your data...</div>
          </div>
          <button class="analysis-close" onclick="closeAnalysisResults()">&times;</button>
        </div>
        <div class="analysis-body" id="analysisBody">
          <div id="analysisLoading" style="text-align: center; padding: 2rem;">
            <div class="ai-spinner" style="margin: 0 auto 1rem;"></div>
            <div style="color: rgba(255, 255, 255, 0.6);">AI is analyzing your data...</div>
          </div>
          <div id="analysisContent" style="display: none;">
            <div class="exec-summary">
              <div class="exec-headline" id="execHeadline"></div>
              <div class="exec-section">
                <div class="exec-section-title">What Changed</div>
                <ul id="execWhatChanged"></ul>
              </div>
              <div class="exec-section">
                <div class="exec-section-title">Why It Happened</div>
                <ul id="execWhy"></ul>
              </div>
              <div class="exec-section">
                <div class="exec-section-title">Recommended Actions</div>
                <ul id="execActions"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TODAY'S INSIGHTS (Proactive) -->
    <div class="insights-section" id="insightsSection">
      <div class="insights-header">
        <h2>Today's Insights</h2>
        <button class="refresh-btn" onclick="refreshInsights()">Refresh</button>
      </div>
      <div class="insights-grid" id="insightsGrid">
        <div class="insight-card info" id="noInsightsPlaceholder">
          <div class="insight-icon">üí°</div>
          <div class="insight-title">Connect accounts to see insights</div>
          <div class="insight-detail">Once you connect your ad platforms, we'll automatically surface important changes and opportunities.</div>
          <div class="insight-action">Connect accounts below ‚Üí</div>
        </div>
      </div>
    </div>

    <!-- QUICK STATS BAR (shown when data available) -->
    <div class="quick-stats" id="quickStats" style="display: none;">
      <div class="quick-stat">
        <div class="quick-stat-value" id="qsSpend">$0</div>
        <div class="quick-stat-label">Spend (7d)</div>
        <div class="quick-stat-change" id="qsSpendChange"></div>
      </div>
      <div class="quick-stat">
        <div class="quick-stat-value" id="qsRevenue">$0</div>
        <div class="quick-stat-label">Revenue (7d)</div>
        <div class="quick-stat-change" id="qsRevenueChange"></div>
      </div>
      <div class="quick-stat">
        <div class="quick-stat-value" id="qsRoas">0.0</div>
        <div class="quick-stat-label">ROAS</div>
        <div class="quick-stat-change" id="qsRoasChange"></div>
      </div>
      <div class="quick-stat">
        <div class="quick-stat-value" id="qsConversions">0</div>
        <div class="quick-stat-label">Conversions</div>
        <div class="quick-stat-change" id="qsConversionsChange"></div>
      </div>
      <div class="quick-stat">
        <div class="quick-stat-value" id="qsClicks">0</div>
        <div class="quick-stat-label">Clicks</div>
        <div class="quick-stat-change" id="qsClicksChange"></div>
      </div>
    </div>

    <!-- Workspace Selector (moved to collapsible) -->
    <div class="collapsible-section" id="workspaceSection">
      <div class="collapsible-header" onclick="toggleSection('workspaceSection')">
        <h3>
          <span style="margin-right: 0.5rem;">üè¢</span>
          Workspace: <span id="currentWorkspaceName" style="color: #b7fa31;">Loading...</span>
        </h3>
        <span class="collapsible-toggle">Change ‚ñº</span>
      </div>
      <div class="collapsible-body">
        <div style="padding: 0.5rem 0;">
          <label style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.5);">Switch workspace</label>
          <select id="workspaceSelect" onchange="handleWorkspaceChange()" style="width: 100%; max-width: 300px; padding: 0.65rem 1rem; border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); background-color: rgba(255, 255, 255, 0.04); color: #fff; font-size: 0.875rem;">
            <option value="">Loading workspaces...</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Hidden: Old date filter (functionality preserved) -->
    <div class="date-filter-bar" id="dateFilterBar" style="display: none;">
      <div class="date-controls">
        <label style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Date Range:</label>
        <div class="date-preset-buttons">
          <button class="date-preset-btn" onclick="setDateRange('today')">Today</button>
          <button class="date-preset-btn active" onclick="setDateRange('last7days')">Last 7 Days</button>
          <button class="date-preset-btn" onclick="setDateRange('last30days')">Last 30 Days</button>
          <button class="date-preset-btn" onclick="setDateRange('thismonth')">This Month</button>
          <button class="date-preset-btn" onclick="setDateRange('lastmonth')">Last Month</button>
        </div>
      </div>
      <div class="date-controls">
        <label style="font-size: 0.875rem; color: rgba(255, 255, 255, 0.6); font-weight: 500;">Compare to:</label>
        <select id="comparisonPeriod" style="min-width: 180px;">
          <option value="previous">Previous Period</option>
          <option value="lastmonth">Same Period Last Month</option>
          <option value="lastyear">Same Period Last Year</option>
        </select>
      </div>
    </div>

    <!-- No Data Message (hidden by default, shown only when needed) -->
    <div class="card" id="noDataMessage" style="display: none;">
      <div style="text-align: center; padding: 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
        <h2 style="margin-bottom: 0.75rem; font-size: 1.25rem;">No performance data yet</h2>
        <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
          Connect your advertising accounts below to see metrics and enable AI analysis.
        </p>
        <a href="#accountsSection" class="btn btn-primary" style="text-decoration: none;">Connect Accounts</a>
      </div>
    </div>

    <!-- KPI Scorecard Grid (shown when data is available) -->
    <div class="dashboard-grid" id="kpiGrid" style="display: none;">
      <!-- Total Spend Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Ad Spend</span>
          </div>
          <div class="scorecard-value" id="totalSpend">$0.00</div>
          <div class="scorecard-comparison neutral" id="spendComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="spendSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Total Revenue Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Revenue</span>
          </div>
          <div class="scorecard-value" id="totalRevenue">$0.00</div>
          <div class="scorecard-comparison neutral" id="revenueComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="revenueSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- ROAS Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">ROAS</span>
          </div>
          <div class="scorecard-value" id="roas">0.00</div>
          <div class="scorecard-comparison neutral" id="roasComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="roasSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Conversions Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Conversions</span>
          </div>
          <div class="scorecard-value" id="conversions">0</div>
          <div class="scorecard-comparison neutral" id="conversionsComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="conversionsSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Clicks Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Total Clicks</span>
          </div>
          <div class="scorecard-value" id="clicks">0</div>
          <div class="scorecard-comparison neutral" id="clicksComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="clicksSparkline"></canvas>
          </div>
        </div>
      </div>

      <!-- Impressions Scorecard -->
      <div class="widget widget-third">
        <div class="scorecard">
          <div class="scorecard-header">
            <span class="scorecard-label">Impressions</span>
          </div>
          <div class="scorecard-value" id="impressions">Loading...</div>
          <div class="scorecard-comparison neutral" id="impressionsComparison">
            <span>‚Äî vs previous period</span>
          </div>
          <div class="sparkline">
            <canvas id="impressionsSparkline"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Accounts Section - Connect & Manage -->
    <div class="card" id="accountsSection">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
        <div>
          <h2 style="margin-bottom: 0.5rem;">Connect Your Ad Platforms</h2>
          <p class="card-subtitle" style="margin-bottom: 0;">Link your advertising accounts to see unified performance data.</p>
        </div>
        <div id="connectedCount" style="background: rgba(183, 250, 49, 0.1); border: 1px solid rgba(183, 250, 49, 0.3); border-radius: 0.75rem; padding: 0.5rem 1rem; font-size: 0.875rem; color: #b7fa31; display: none;">
          <span id="connectedCountText">0 connected</span>
        </div>
      </div>

      <div class="connection-grid">
        <!-- Meta Ads -->
        <div class="connection-card" id="metaCard">
          <div class="platform-icon">üìò</div>
          <div class="platform-name">Meta Ads</div>
          <div class="connection-status" id="metaStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectMeta()" id="metaConnectBtn">Connect</button>
        </div>

        <!-- Google Ads -->
        <div class="connection-card" id="googleCard">
          <div class="platform-icon">üîç</div>
          <div class="platform-name">Google Ads</div>
          <div class="connection-status" id="googleStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectGoogle()" id="googleConnectBtn">Connect</button>
        </div>

        <!-- Search Console -->
        <div class="connection-card" id="searchConsoleCard">
          <div class="platform-icon">üîé</div>
          <div class="platform-name">Search Console</div>
          <div class="connection-status" id="searchConsoleStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectSearchConsole()" id="searchConsoleConnectBtn">Connect</button>
        </div>

        <!-- TikTok Ads -->
        <div class="connection-card" id="tiktokCard">
          <div class="platform-icon">üéµ</div>
          <div class="platform-name">TikTok Ads</div>
          <div class="connection-status" id="tiktokStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectTikTok()" id="tiktokConnectBtn">Connect</button>
        </div>

        <!-- LinkedIn Ads -->
        <div class="connection-card" id="linkedinCard">
          <div class="platform-icon">üíº</div>
          <div class="platform-name">LinkedIn Ads</div>
          <div class="connection-status" id="linkedinStatus">Not connected</div>
          <button class="btn btn-primary" onclick="connectLinkedIn()" id="linkedinConnectBtn">Connect</button>
        </div>

        <!-- Custom Data -->
        <div class="connection-card" style="background: linear-gradient(135deg, rgba(103, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid rgba(103, 126, 234, 0.3);">
          <div class="platform-icon">üìä</div>
          <div class="platform-name">Custom Data</div>
          <div class="connection-status" style="color: #b7fa31;">Import Excel/CSV</div>
          <button class="btn btn-primary" onclick="window.location.href='/custom-data.html'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Upload</button>
        </div>
      </div>

      <!-- Connected Accounts List (shows when accounts exist) -->
      <div id="connectedAccountsList" style="margin-top: 2rem; display: none;">
        <h3 style="font-size: 1rem; margin-bottom: 1rem; color: rgba(255, 255, 255, 0.8);">Connected Accounts</h3>
        <div id="accountsList">
          <div class="loading">Loading accounts...</div>
        </div>
      </div>
    </div>

    <div class="card analyst-panel hidden" id="analystPanel">
      <div class="analyst-header" onclick="toggleAnalystPanel()">
        <div class="analyst-header-left">
          <h3>AI Marketing Analyst</h3>
          <span class="badge">Beta</span>
        </div>
        <div class="analyst-toggle">
          <span>Expand</span>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
      </div>
      <div class="analyst-body">
      <p style="margin-bottom: 1rem;">Ask a question about your marketing data and get AI-powered insights.</p>

      <!-- Row 1: Data Source Selection -->
      <div class="analyst-grid">
        <div>
          <label for="analystSource">Data Source</label>
          <select id="analystSource">
            <option value="">Select source</option>
            <option value="meta_ads">Meta Ads</option>
            <option value="search_console">Search Console</option>
            <option value="custom_data">Custom data</option>
          </select>
        </div>
        <div>
          <label for="analystAccount">Account</label>
          <select id="analystAccount">
            <option value="">Select account</option>
          </select>
        </div>
        <div>
          <label for="analystEntityLevel">Entity Level</label>
          <select id="analystEntityLevel">
            <option value="account">Account</option>
            <option value="campaign">Campaign</option>
            <option value="adset">Ad set</option>
          </select>
        </div>
      </div>

      <div id="analystScopeWarning" class="analyst-warning">
        No synced analytics data. Select a connected account or upload custom data.
      </div>

      <span id="analystScopePill" class="analyst-scope-pill" style="display:none; margin-bottom: 1rem;">Analyzing scope</span>

      <!-- Row 2: Question -->
      <div style="margin-bottom: 1rem;">
        <label for="analystQuestion" style="display:block; font-size:0.75rem; text-transform:uppercase; letter-spacing:0.05em; color:rgba(255,255,255,0.6); margin-bottom:0.4rem;">Business Question</label>
        <textarea id="analystQuestion" rows="2" placeholder="e.g., Why did ROAS drop this week compared to last week?" style="width:100%; padding:0.65rem 0.875rem; border-radius:0.5rem; border:1px solid rgba(255,255,255,0.1); background-color:rgba(255,255,255,0.04); color:#fff; font-family:'Inter',sans-serif; font-size:0.85rem; resize:vertical;"></textarea>
      </div>

      <!-- Row 3: Date Range & Options -->
      <div class="analyst-grid" style="grid-template-columns: repeat(5, 1fr);">
        <div>
          <label for="analystStart">Start Date</label>
          <input id="analystStart" type="date">
        </div>
        <div>
          <label for="analystEnd">End Date</label>
          <input id="analystEnd" type="date">
        </div>
        <div>
          <label for="analystKpi">Primary KPI</label>
          <select id="analystKpi">
            <option value="roas">ROAS</option>
            <option value="spend">Spend</option>
            <option value="cpa">CPA</option>
            <option value="clicks">Clicks</option>
            <option value="revenue">Revenue</option>
          </select>
        </div>
        <div>
          <label for="analystCompare">Compare</label>
          <select id="analystCompare">
            <option value="previous_period">Previous period</option>
            <option value="yoy">Year-over-year</option>
            <option value="none">None</option>
          </select>
        </div>
        <div id="debugModeContainer" style="display:none; align-items:flex-end;">
          <label for="analystDebug" style="display:flex; align-items:center; gap:0.35rem; padding-top: 1.5rem;">
            <input id="analystDebug" type="checkbox" style="transform:scale(1.05);">
            <span style="font-size:0.75rem; color:rgba(255,255,255,0.6);">Debug</span>
          </label>
        </div>
      </div>

      <!-- Action Button -->
      <div style="display:flex; align-items:center; gap:1rem; margin-top: 0.5rem;">
        <button id="analystRunBtn" class="btn btn-primary" title="Select a data source, account, and enter a question to enable analysis">Analyze with AI</button>
        <span id="analystStatus" class="analyst-status">Idle</span>
      </div>
      <div class="analyst-results" id="analystResults">
        <div class="analyst-section">
          <h4>Executive summary</h4>
          <div id="analystExecHeadline" style="font-size:1.1rem; font-weight:600; margin-bottom:0.4rem;"></div>
          <div>
            <strong style="font-size:0.8rem; letter-spacing:0.05em; color:rgba(255,255,255,0.55);">What changed</strong>
            <ul id="analystExecWhatChanged"></ul>
          </div>
          <div>
            <strong style="font-size:0.8rem; letter-spacing:0.05em; color:rgba(255,255,255,0.55);">Why it happened</strong>
            <ul id="analystExecWhy"></ul>
          </div>
          <div>
            <strong style="font-size:0.8rem; letter-spacing:0.05em; color:rgba(255,255,255,0.55);">Next steps</strong>
            <ul id="analystExecNext"></ul>
          </div>
        </div>
        <div class="analyst-section">
          <h4>Findings</h4>
          <div id="analystFindingsList"></div>
        </div>
        <div class="analyst-section">
          <h4>Actions</h4>
          <div id="analystActionsList"></div>
        </div>
        <div class="analyst-section">
          <details class="analyst-details">
            <summary>Evidence</summary>
            <div id="analystEvidenceList"></div>
          </details>
        </div>
        <div class="analyst-section" id="analystTraceSection" style="display:none;">
          <h4>Agent trace</h4>
          <div class="analyst-trace" id="analystTraceContent"></div>
        </div>
      </div>
      </div>
    </div>

    <div class="card">
      <h2>My Dashboards</h2>
      <p class="card-subtitle">Create custom dashboards with the metrics you want to track. Build manually or use AI to generate automatically.</p>
      <div id="dashboardsList">
        <div class="loading">Loading dashboards...</div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Dashboard Modal -->
  <div id="dashboardModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Create New Dashboard</h3>
        <button class="close-btn" onclick="closeDashboardModal()">&times;</button>
      </div>
      <form id="dashboardForm" onsubmit="saveDashboard(event)">
        <div class="form-group">
          <label for="dashboardName">Dashboard Name *</label>
          <input type="text" id="dashboardName" required placeholder="e.g., Q4 Performance Dashboard">
        </div>
        <div class="form-group">
          <label for="dashboardDescription">Description</label>
          <textarea id="dashboardDescription" placeholder="Describe what this dashboard will track..."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeDashboardModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Dashboard</button>
        </div>
      </form>
    </div>
  </div>

  <!-- AI Dashboard Generation Modal -->
  <div id="aiModal" class="modal">
    <div class="modal-content ai-modal-content">
      <div class="modal-header">
        <h3>Generate Dashboard with AI</h3>
        <button class="close-btn" onclick="closeAIModal()">&times;</button>
      </div>
      <div id="aiFormSection">
        <div class="form-group">
          <label for="aiAdAccount">Select Ad Account</label>
          <select id="aiAdAccount" class="form-control" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
            <option value="">Loading accounts...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="aiPrompt">Describe your dashboard</label>
          <textarea id="aiPrompt" class="ai-prompt-textarea" placeholder="e.g., Create a dashboard to track e-commerce performance with focus on ROAS, conversion costs, and daily spend trends. Include comparison charts and KPI cards for key metrics."></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeAIModal()">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="generateAIDashboard()" style="background-color: #9333ea;">Generate with AI</button>
        </div>
      </div>
      <div id="aiGenerating" class="ai-generating" style="display: none;">
        <div class="ai-spinner"></div>
        <div>Generating your dashboard...</div>
        <div style="font-size: 0.875rem; color: rgba(255,255,255,0.5); margin-top: 0.5rem;">This may take a few seconds</div>
      </div>
      <div id="aiPreviewSection" style="display: none;">
        <div class="ai-preview">
          <h4 id="aiPreviewName">Dashboard Name</h4>
          <div id="aiPreviewDescription" style="font-size: 0.875rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem;"></div>
          <div id="aiPreviewWidgets"></div>
        </div>
        <div id="aiInsights" class="ai-insights" style="display: none;">
          <h4>AI Insights</h4>
          <ul id="aiInsightsList"></ul>
        </div>
        <div class="modal-footer" style="margin-top: 1rem;">
          <button type="button" class="btn btn-secondary" onclick="resetAIModal()">Try Again</button>
          <button type="button" class="btn btn-primary" onclick="createAIDashboard()" style="background-color: #9333ea;">Create Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let workspaces = [];
    let selectedWorkspaceId = null;
    let aiGeneratedConfig = null;
    let currentDateRange = 'last7days';
    let currentComparison = 'previous';
    let analystAccountsBySource = { meta_ads: [], search_console: [] };
    let analystCustomSources = [];
    let analystNoDataBannerVisible = true;
    let connectedAccounts = [];

    // ==========================================
    // QUESTION-FIRST INTERFACE FUNCTIONS
    // ==========================================

    function setQuestionSuggestion(question) {
      document.getElementById('heroQuestionInput').value = question;
      document.getElementById('heroQuestionInput').focus();
    }

    async function submitHeroQuestion() {
      const input = document.getElementById('heroQuestionInput');
      const question = input.value.trim();
      if (!question) {
        showAlert('Please enter a question', 'warning');
        return;
      }

      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      // Check if we have any connected accounts
      if (connectedAccounts.length === 0) {
        showAlert('Please connect at least one ad platform first', 'warning');
        document.getElementById('accountsSection').scrollIntoView({ behavior: 'smooth' });
        return;
      }

      // Show analysis results section
      const resultsSection = document.getElementById('analysisResults');
      resultsSection.classList.add('show');
      document.getElementById('analysisQuestionText').textContent = question;
      document.getElementById('analysisMeta').textContent = 'Analyzing your data...';
      document.getElementById('analysisLoading').style.display = 'block';
      document.getElementById('analysisContent').style.display = 'none';

      // Scroll to results
      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Auto-detect scope from question
      const scope = detectScopeFromQuestion(question);

      // Set date range (default last 7 days)
      const today = new Date();
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);

      try {
        const response = await fetch('/api/ai/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({
            workspaceId: selectedWorkspaceId,
            question: question,
            dateRange: {
              start: weekAgo.toISOString().split('T')[0],
              end: today.toISOString().split('T')[0]
            },
            scope: scope,
            primaryKpi: 'roas',
            compareMode: 'previous_period'
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Analysis failed');
        }

        // Display results
        displayAnalysisResults(data, question);
      } catch (error) {
        console.error('Analysis error:', error);
        document.getElementById('analysisLoading').style.display = 'none';
        document.getElementById('analysisContent').innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #ef4444;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Analysis Failed</div>
            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${error.message}</div>
          </div>
        `;
        document.getElementById('analysisContent').style.display = 'block';
      }
    }

    function detectScopeFromQuestion(question) {
      const q = question.toLowerCase();
      let source = null;
      let accountId = null;

      // Detect platform from question
      if (q.includes('meta') || q.includes('facebook') || q.includes('instagram')) {
        source = 'meta_ads';
        const metaAccounts = connectedAccounts.filter(a => a.platform === 'meta');
        if (metaAccounts.length > 0) accountId = metaAccounts[0].account_id;
      } else if (q.includes('google') && !q.includes('search console')) {
        source = 'google_ads';
        const googleAccounts = connectedAccounts.filter(a => a.platform === 'google');
        if (googleAccounts.length > 0) accountId = googleAccounts[0].account_id;
      } else if (q.includes('search console') || q.includes('organic') || q.includes('seo')) {
        source = 'search_console';
        const scAccounts = connectedAccounts.filter(a => a.platform === 'search_console');
        if (scAccounts.length > 0) accountId = scAccounts[0].account_name;
      } else if (q.includes('tiktok')) {
        source = 'tiktok_ads';
        const ttAccounts = connectedAccounts.filter(a => a.platform === 'tiktok');
        if (ttAccounts.length > 0) accountId = ttAccounts[0].account_id;
      } else if (q.includes('linkedin')) {
        source = 'linkedin_ads';
        const liAccounts = connectedAccounts.filter(a => a.platform === 'linkedin');
        if (liAccounts.length > 0) accountId = liAccounts[0].account_id;
      } else {
        // Default to first available account (usually Meta)
        const metaAccounts = connectedAccounts.filter(a => a.platform === 'meta');
        if (metaAccounts.length > 0) {
          source = 'meta_ads';
          accountId = metaAccounts[0].account_id;
        } else if (connectedAccounts.length > 0) {
          const first = connectedAccounts[0];
          source = first.platform === 'meta' ? 'meta_ads' :
                   first.platform === 'search_console' ? 'search_console' :
                   first.platform + '_ads';
          accountId = first.account_id || first.account_name;
        }
      }

      return {
        source: source || 'meta_ads',
        accountId: accountId || '',
        entityLevel: 'account'
      };
    }

    function displayAnalysisResults(data, question) {
      document.getElementById('analysisLoading').style.display = 'none';

      const execSummary = data.exec_summary || {};
      const content = document.getElementById('analysisContent');

      // Update meta
      document.getElementById('analysisMeta').textContent =
        `Analyzed ${data.scope?.source || 'your data'} ‚Ä¢ ${new Date().toLocaleString()}`;

      // Executive headline
      document.getElementById('execHeadline').textContent = execSummary.headline || 'Analysis Complete';

      // What changed
      const whatChangedList = document.getElementById('execWhatChanged');
      whatChangedList.innerHTML = (execSummary.what_changed || ['No significant changes detected'])
        .map(item => `<li>${item}</li>`).join('');

      // Why
      const whyList = document.getElementById('execWhy');
      whyList.innerHTML = (execSummary.why || ['Further investigation needed'])
        .map(item => `<li>${item}</li>`).join('');

      // Actions
      const actionsList = document.getElementById('execActions');
      const actions = data.actions || [];
      actionsList.innerHTML = (execSummary.what_to_do_next || actions.map(a => a.action) || ['Continue monitoring'])
        .map(item => `<li>${item}</li>`).join('');

      content.style.display = 'block';
    }

    function closeAnalysisResults() {
      document.getElementById('analysisResults').classList.remove('show');
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('open');
    }

    async function refreshInsights() {
      // This would call the backend to get proactive insights
      // For now, we'll show mock insights based on connected accounts
      const grid = document.getElementById('insightsGrid');

      if (connectedAccounts.length === 0) {
        grid.innerHTML = `
          <div class="insight-card info" id="noInsightsPlaceholder">
            <div class="insight-icon">üí°</div>
            <div class="insight-title">Connect accounts to see insights</div>
            <div class="insight-detail">Once you connect your ad platforms, we'll automatically surface important changes and opportunities.</div>
            <div class="insight-action">Connect accounts below ‚Üí</div>
          </div>
        `;
        return;
      }

      // Show loading
      grid.innerHTML = '<div style="padding: 1rem; color: rgba(255,255,255,0.5);">Analyzing your data for insights...</div>';

      // TODO: Call actual insights API
      // For now, show placeholder insights
      setTimeout(() => {
        grid.innerHTML = `
          <div class="insight-card alert" onclick="setQuestionSuggestion('Why did my CPA increase recently?'); submitHeroQuestion();">
            <div class="insight-icon">‚ö†Ô∏è</div>
            <div class="insight-title">CPA trending up</div>
            <div class="insight-detail">Your cost per acquisition has increased 12% over the past 7 days. Click to investigate.</div>
            <div class="insight-action">Investigate ‚Üí</div>
          </div>
          <div class="insight-card opportunity" onclick="setQuestionSuggestion('Which campaigns should I scale?'); submitHeroQuestion();">
            <div class="insight-icon">üìà</div>
            <div class="insight-title">Scale opportunity</div>
            <div class="insight-detail">2 campaigns are performing above target ROAS. Consider increasing budget.</div>
            <div class="insight-action">View campaigns ‚Üí</div>
          </div>
          <div class="insight-card info" onclick="setQuestionSuggestion('What is my overall performance this week?'); submitHeroQuestion();">
            <div class="insight-icon">üìä</div>
            <div class="insight-title">Weekly summary ready</div>
            <div class="insight-detail">Your weekly performance report is ready. Click to see the AI analysis.</div>
            <div class="insight-action">View summary ‚Üí</div>
          </div>
        `;
      }, 1000);
    }

    function updateQuickStats(metrics) {
      const hasData = metrics && metrics.length > 0;

      if (!hasData) {
        document.getElementById('quickStats').style.display = 'none';
        return;
      }

      // Calculate totals
      let totalSpend = 0, totalRevenue = 0, totalConversions = 0, totalClicks = 0;
      metrics.forEach(m => {
        totalSpend += parseFloat(m.spend || 0);
        totalRevenue += parseFloat(m.revenue || 0);
        totalConversions += parseInt(m.conversions || 0);
        totalClicks += parseInt(m.clicks || 0);
      });

      const roas = totalSpend > 0 ? (totalRevenue / totalSpend).toFixed(2) : '0.00';

      document.getElementById('qsSpend').textContent = '$' + totalSpend.toLocaleString(undefined, {maximumFractionDigits: 0});
      document.getElementById('qsRevenue').textContent = '$' + totalRevenue.toLocaleString(undefined, {maximumFractionDigits: 0});
      document.getElementById('qsRoas').textContent = roas;
      document.getElementById('qsConversions').textContent = totalConversions.toLocaleString();
      document.getElementById('qsClicks').textContent = totalClicks.toLocaleString();

      document.getElementById('quickStats').style.display = 'flex';
    }

    // ==========================================
    // END QUESTION-FIRST FUNCTIONS
    // ==========================================

    // Check for OAuth callback messages
  window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const oauthStatus = urlParams.get('oauth');
    const platform = urlParams.get('platform');
    const message = urlParams.get('message');

    if (oauthStatus === 'success') {
      showAlert(`Successfully connected ${platform} account!`, 'success');
      // Clean URL
      window.history.replaceState({}, document.title, '/dashboard');
      loadAccounts();
    } else if (oauthStatus === 'error') {
      showAlert(`Failed to connect account: ${message || 'Unknown error'}`, 'error');
      window.history.replaceState({}, document.title, '/dashboard');
    }

    initAnalystMode();
    loadUser();
  });

    async function loadUser() {
      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'include'
        });

        if (!response.ok) {
          window.location.href = '/login';
          return;
        }

        const data = await response.json();
        currentUser = data.user;
        document.getElementById('userEmail').textContent = currentUser.email;

        // Load workspaces
        await loadWorkspaces();
      } catch (error) {
        console.error('Error loading user:', error);
        window.location.href = '/login';
      }
    }

    async function loadWorkspaces() {
      try {
        const response = await fetch('/api/workspaces', {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to load workspaces');
        }

        const data = await response.json();
        workspaces = data.data || [];

        const select = document.getElementById('workspaceSelect');
        select.innerHTML = '';

        if (workspaces.length === 0) {
          select.innerHTML = '<option value="">No workspaces available</option>';
          return;
        }

        workspaces.forEach(workspace => {
          const option = document.createElement('option');
          option.value = workspace.id;
          option.textContent = workspace.name;
          select.appendChild(option);
        });

        // Select first workspace by default
        selectedWorkspaceId = workspaces[0].id;
        select.value = selectedWorkspaceId;
        localStorage.setItem('selectedWorkspaceId', selectedWorkspaceId);
        document.getElementById('currentWorkspaceName').textContent = workspaces[0].name;

        await loadAccounts();
        await loadDashboards();
      } catch (error) {
        console.error('Error loading workspaces:', error);
        showAlert('Failed to load workspaces', 'error');
      }
    }

    async function handleWorkspaceChange() {
      const select = document.getElementById('workspaceSelect');
      selectedWorkspaceId = select.value;
      localStorage.setItem('selectedWorkspaceId', selectedWorkspaceId);

      // Update workspace name display
      const selectedWorkspace = workspaces.find(w => w.id === selectedWorkspaceId);
      if (selectedWorkspace) {
        document.getElementById('currentWorkspaceName').textContent = selectedWorkspace.name;
      }

      await loadAccounts();
      await loadDashboards();
      await loadKPIData();
    }

    // Date Range Functions
    function setDateRange(range) {
      currentDateRange = range;

      // Update button states
      document.querySelectorAll('.date-preset-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Reload KPI data
      loadKPIData();
    }

    async function loadKPIData() {
      if (!selectedWorkspaceId) return;

      try {
        // Calculate date range
        const { startDate, endDate } = getDateRangeFromPreset(currentDateRange);

        // Fetch metrics from unified endpoint
        const response = await fetch(`/api/unified/metrics?workspaceId=${selectedWorkspaceId}&startDate=${startDate}&endDate=${endDate}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          console.error('Failed to load KPI data');
          // Still update cards with empty data to show zeros
          updateKPICards([]);
          return;
        }

        const data = await response.json();

        // Always update KPI cards (will show zeros if no data)
        updateKPICards(data.metrics || []);
      } catch (error) {
        console.error('Error loading KPI data:', error);
        // Show zeros on error
        updateKPICards([]);
      }
    }

    function getDateRangeFromPreset(preset) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let startDate, endDate;

      switch (preset) {
        case 'today':
          startDate = new Date(today);
          endDate = new Date(today);
          endDate.setHours(23, 59, 59, 999);
          break;
        case 'last7days':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 7);
          endDate = new Date(today);
          break;
        case 'last30days':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 30);
          endDate = new Date(today);
          break;
        case 'thismonth':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today);
          break;
        case 'lastmonth':
          startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          endDate = new Date(today.getFullYear(), today.getMonth(), 0);
          break;
        default:
          startDate = new Date(today);
          startDate.setDate(today.getDate() - 7);
          endDate = new Date(today);
      }

      return {
        startDate: startDate.toISOString().split('T')[0],
        endDate: endDate.toISOString().split('T')[0]
      };
    }

    // Store sparkline chart instances
    const sparklineCharts = {};

    function updateKPICards(metrics) {
      // Update quick stats bar (new question-first interface)
      updateQuickStats(metrics);

      // Refresh proactive insights when we have accounts
      if (connectedAccounts.length > 0) {
        refreshInsights();
      }

      // Check if we have any meaningful data
      const hasData = metrics && metrics.length > 0;

      if (!hasData) {
        // Hide old KPI grid (we use quick stats now)
        document.getElementById('kpiGrid').style.display = 'none';
        document.getElementById('dateFilterBar').style.display = 'none';
        return;
      }

      // Aggregate metrics across all platforms
      let totalSpend = 0;
      let totalRevenue = 0;
      let totalConversions = 0;
      let totalClicks = 0;
      let totalImpressions = 0;

      // Group metrics by date for sparklines
      const dailyData = {};

      metrics.forEach(metric => {
        const date = metric.date || metric.created_at?.split('T')[0] || new Date().toISOString().split('T')[0];

        if (!dailyData[date]) {
          dailyData[date] = { spend: 0, revenue: 0, conversions: 0, clicks: 0, impressions: 0 };
        }

        dailyData[date].spend += parseFloat(metric.spend || 0);
        dailyData[date].revenue += parseFloat(metric.revenue || 0);
        dailyData[date].conversions += parseInt(metric.conversions || 0);
        dailyData[date].clicks += parseInt(metric.clicks || 0);
        dailyData[date].impressions += parseInt(metric.impressions || 0);

        totalSpend += parseFloat(metric.spend || 0);
        totalRevenue += parseFloat(metric.revenue || 0);
        totalConversions += parseInt(metric.conversions || 0);
        totalClicks += parseInt(metric.clicks || 0);
        totalImpressions += parseInt(metric.impressions || 0);
      });

      // Check if all values are zero (no real data)
      const hasRealData = totalSpend > 0 || totalRevenue > 0 || totalConversions > 0 || totalClicks > 0 || totalImpressions > 0;

      if (!hasRealData) {
        // Show no data message, hide KPI grid and date filter
        document.getElementById('noDataMessage').style.display = 'block';
        document.getElementById('kpiGrid').style.display = 'none';
        document.getElementById('dateFilterBar').style.display = 'none';
        analystNoDataBannerVisible = true;
        updateAnalystWarning();
        updateAnalystButtonState();
        return;
      }

      // Hide no data message, show KPI grid and date filter
      document.getElementById('noDataMessage').style.display = 'none';
      document.getElementById('kpiGrid').style.display = 'grid';
      document.getElementById('dateFilterBar').style.display = 'flex';
      analystNoDataBannerVisible = false;
      updateAnalystWarning();
      updateAnalystButtonState();

      const roas = totalSpend > 0 ? (totalRevenue / totalSpend) : 0;

      // Update scorecard values
      document.getElementById('totalSpend').textContent = formatCurrency(totalSpend);
      document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
      document.getElementById('roas').textContent = roas.toFixed(2) + 'x'; // Show as multiplier, not currency
      document.getElementById('conversions').textContent = formatNumber(totalConversions);
      document.getElementById('clicks').textContent = formatNumber(totalClicks);
      document.getElementById('impressions').textContent = formatNumber(totalImpressions);

      // Prepare sparkline data
      const dates = Object.keys(dailyData).sort();
      const spendData = dates.map(date => dailyData[date].spend);
      const revenueData = dates.map(date => dailyData[date].revenue);
      const roasData = dates.map(date => {
        const s = dailyData[date].spend;
        const r = dailyData[date].revenue;
        return s > 0 ? r / s : 0;
      });
      const conversionsData = dates.map(date => dailyData[date].conversions);
      const clicksData = dates.map(date => dailyData[date].clicks);
      const impressionsData = dates.map(date => dailyData[date].impressions);

      // Create/update sparklines only if we have date data
      if (dates.length > 0) {
        createSparkline('spendSparkline', spendData);
        createSparkline('revenueSparkline', revenueData);
        createSparkline('roasSparkline', roasData);
        createSparkline('conversionsSparkline', conversionsData);
        createSparkline('clicksSparkline', clicksData);
        createSparkline('impressionsSparkline', impressionsData);
      }

      // Calculate comparison with previous period (mock data for now)
      // TODO: Calculate real comparison when we have previous period data
      updateComparison('spendComparison', 0);
      updateComparison('revenueComparison', 0);
      updateComparison('roasComparison', 0);
      updateComparison('conversionsComparison', 0);
      updateComparison('clicksComparison', 0);
      updateComparison('impressionsComparison', 0);
    }

    function createSparkline(canvasId, data) {
      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      // Destroy existing chart if it exists
      if (sparklineCharts[canvasId]) {
        sparklineCharts[canvasId].destroy();
      }

      // Create new sparkline chart
      sparklineCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map((_, i) => i),
          datasets: [{
            data: data,
            borderColor: '#b7fa31',
            backgroundColor: 'rgba(183, 250, 49, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          },
          scales: {
            x: { display: false },
            y: { display: false }
          },
          interaction: {
            mode: 'index',
            intersect: false
          }
        }
      });
    }

    function updateComparison(elementId, percentage) {
      const element = document.getElementById(elementId);

      if (percentage === 0) {
        element.className = 'scorecard-comparison neutral';
        element.innerHTML = `<span>‚Äî vs previous period</span>`;
        return;
      }

      const isPositive = percentage > 0;
      const arrow = isPositive ? '‚Üë' : '‚Üì';
      const sign = isPositive ? '+' : '';

      element.className = `scorecard-comparison ${isPositive ? 'positive' : 'negative'}`;
      element.innerHTML = `<span>${arrow} ${sign}${Math.abs(percentage).toFixed(1)}% vs previous period</span>`;
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(value);
    }

    function formatNumber(value) {
      return new Intl.NumberFormat('en-US').format(value);
    }

    async function loadAccounts() {
      if (!selectedWorkspaceId) {
        document.getElementById('accountsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÅ</div><div>Please select a workspace</div></div>';
        return;
      }

      const workspaceId = selectedWorkspaceId || (workspaces[0] && workspaces[0].id);
      if (!workspaceId) {
        select.innerHTML = '<option value="">Select a workspace to load accounts</option>';
        return;
      }

      try {
        const response = await fetch(`/api/oauth/accounts/${workspaceId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to load accounts');
        }

        const data = await response.json();
        const accounts = data.data || [];
        connectedAccounts = accounts; // Store for question-first interface
        analystAccountsBySource.meta_ads = accounts
          .filter((account) => account.platform === 'meta')
          .map((account) => ({
            value: account.account_id,
            label: `${account.account_name || 'Meta Ads'} (${account.account_id})`,
          }));
        analystAccountsBySource.search_console = accounts
          .filter((account) => account.platform === 'search_console')
          .map((account) => ({
            value: account.account_name || account.account_id,
            label: `${account.account_name || 'Search Console'} (${account.account_id})`,
            propertyUrl: account.account_name || '',
          }));
        analystCustomSources = [];

        const accountsList = document.getElementById('accountsList');
        const connectedCountEl = document.getElementById('connectedCount');
        const connectedAccountsListEl = document.getElementById('connectedAccountsList');
        const analystPanel = document.getElementById('analystPanel');

        if (accounts.length === 0) {
          accountsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîå</div><div>No connected accounts yet.</div></div>';
          // Hide connected count and connected accounts list
          if (connectedCountEl) connectedCountEl.style.display = 'none';
          if (connectedAccountsListEl) connectedAccountsListEl.style.display = 'none';
          // Hide analyst panel when no accounts
          if (analystPanel) analystPanel.classList.add('hidden');
          return;
        }

        // Show connected count
        if (connectedCountEl) {
          connectedCountEl.style.display = 'block';
          document.getElementById('connectedCountText').textContent = `${accounts.length} connected`;
        }
        // Show connected accounts list
        if (connectedAccountsListEl) connectedAccountsListEl.style.display = 'block';
        // Show analyst panel when accounts exist
        if (analystPanel) analystPanel.classList.remove('hidden');

        let htmlContent = accounts.map(account => {
          const source = account.platform === 'meta' ? 'meta_ads' : account.platform === 'search_console' ? 'search_console' : account.platform;
          const value = source === 'meta_ads' ? account.account_id : account.account_name || account.account_id;
          const label = account.account_name || `${source} ${account.account_id}`;
          const propertyUrl = source === 'search_console' ? account.account_name || '' : '';
          return `
          <div class="account-item" data-source="${source}" data-account-value="${value}" data-account-label="${label}" data-property-url="${propertyUrl}">
            <div class="account-info">
              <div class="account-name">${account.platform.toUpperCase()}: ${account.account_name}</div>
              <div class="account-id">Account ID: ${account.account_id}</div>
            </div>
            <div class="account-actions">
              <span class="account-status ${account.status}">${account.status}</span>
              <button class="btn btn-danger" onclick="disconnectAccount('${account.id}')">Disconnect</button>
            </div>
          </div>
        `;
        }).join('');

        // Load custom data sources
        try {
          const customDataResponse = await fetch(`/api/workspaces/${selectedWorkspaceId}/custom-data/sources`, {
            credentials: 'include'
          });

          if (customDataResponse.ok) {
            const customData = await customDataResponse.json();
            const sources = customData.data || customData.sources || [];

            if (sources.length > 0) {
              analystCustomSources = sources.map((source) => ({
                value: source.id,
                label: `Custom: ${source.source_name}`,
              }));
              htmlContent += sources.map(source => `
                <div class="account-item" data-source="custom_data" data-account-value="${source.id}" data-account-label="Custom: ${source.source_name}" style="background: linear-gradient(135deg, rgba(103, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%); border-left: 3px solid #667eea;">
                  <div class="account-info">
                    <div class="account-name">üìä CUSTOM DATA: ${source.source_name}</div>
                    <div class="account-id">Type: ${source.source_type.toUpperCase()} | Rows: ${source.row_count || 0}</div>
                  </div>
                  <div class="account-actions">
                    <span class="account-status connected" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">imported</span>
                    <button class="btn btn-danger" onclick="deleteCustomData('${source.id}')">Delete</button>
                  </div>
                </div>
              `).join('');
            } else {
              analystCustomSources = [];
            }
          }
        } catch (error) {
          console.error('Error loading custom data sources:', error);
        }

        accountsList.innerHTML = htmlContent;
        attachAccountClickHandlers();
        updateAnalystWarning();
        updateAnalystButtonState();

        // Update Meta status
        const metaAccounts = accounts.filter(a => a.platform === 'meta');
        if (metaAccounts.length > 0) {
          document.getElementById('metaStatus').textContent = `Connected (${metaAccounts.length} account${metaAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('metaStatus').classList.add('connected');
          document.getElementById('metaCard').classList.add('connected');
          document.getElementById('metaConnectBtn').textContent = 'Reconnect';
        }

        // Update Google Ads status
        const googleAccounts = accounts.filter(a => a.platform === 'google');
        if (googleAccounts.length > 0) {
          document.getElementById('googleStatus').textContent = `Connected (${googleAccounts.length} account${googleAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('googleStatus').classList.add('connected');
          document.getElementById('googleCard').classList.add('connected');
          document.getElementById('googleConnectBtn').textContent = 'Reconnect';
        }

        // Update Search Console status
        const searchConsoleAccounts = accounts.filter(a => a.platform === 'search_console');
        if (searchConsoleAccounts.length > 0) {
          document.getElementById('searchConsoleStatus').textContent = `Connected (${searchConsoleAccounts.length} property${searchConsoleAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('searchConsoleStatus').classList.add('connected');
          document.getElementById('searchConsoleCard').classList.add('connected');
          document.getElementById('searchConsoleConnectBtn').textContent = 'Reconnect';
        }

        // Update TikTok status
        const tiktokAccounts = accounts.filter(a => a.platform === 'tiktok');
        if (tiktokAccounts.length > 0) {
          document.getElementById('tiktokStatus').textContent = `Connected (${tiktokAccounts.length} account${tiktokAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('tiktokStatus').classList.add('connected');
          document.getElementById('tiktokCard').classList.add('connected');
          document.getElementById('tiktokConnectBtn').textContent = 'Reconnect';
        }

        // Update LinkedIn status
        const linkedinAccounts = accounts.filter(a => a.platform === 'linkedin');
        if (linkedinAccounts.length > 0) {
          document.getElementById('linkedinStatus').textContent = `Connected (${linkedinAccounts.length} account${linkedinAccounts.length > 1 ? 's' : ''})`;
          document.getElementById('linkedinStatus').classList.add('connected');
          document.getElementById('linkedinCard').classList.add('connected');
          document.getElementById('linkedinConnectBtn').textContent = 'Reconnect';
        }
      } catch (error) {
        console.error('Error loading accounts:', error);
        document.getElementById('accountsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Failed to load accounts</div></div>';
      }
    }

    async function connectMeta() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/meta?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        // Redirect to Meta OAuth
        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting Meta:', error);
        showAlert(error.message, 'error');
      }
    }

    async function connectGoogle() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/google?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        // Redirect to Google OAuth
        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting Google Ads:', error);
        showAlert(error.message, 'error');
      }
    }

    async function connectSearchConsole() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/search-console?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        // Redirect to Search Console OAuth
        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting Search Console:', error);
        showAlert(error.message, 'error');
      }
    }

    async function connectTikTok() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/tiktok?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting TikTok:', error);
        showAlert(error.message, 'error');
      }
    }

    async function connectLinkedIn() {
      if (!selectedWorkspaceId) {
        showAlert('Please select a workspace first', 'warning');
        return;
      }

      try {
        const response = await fetch(`/api/oauth/linkedin?workspaceId=${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Failed to initiate OAuth');
        }

        window.location.href = data.authUrl;
      } catch (error) {
        console.error('Error connecting LinkedIn:', error);
        showAlert(error.message, 'error');
      }
    }

    async function disconnectAccount(accountId) {
      if (!confirm('Are you sure you want to disconnect this account?')) {
        return;
      }

      try {
        const response = await fetch(`/api/oauth/accounts/${accountId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to disconnect account');
        }

        showAlert('Account disconnected successfully', 'success');
        await loadAccounts();
      } catch (error) {
        console.error('Error disconnecting account:', error);
        showAlert('Failed to disconnect account', 'error');
      }
    }

    async function deleteCustomData(sourceId) {
      if (!confirm('Are you sure you want to delete this custom data source? All data will be permanently removed.')) {
        return;
      }

      try {
        const response = await fetch(`/api/workspaces/${selectedWorkspaceId}/custom-data/sources/${sourceId}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to delete custom data source');
        }

        showAlert('Custom data source deleted successfully', 'success');
        await loadAccounts();
      } catch (error) {
        console.error('Error deleting custom data source:', error);
        showAlert('Failed to delete custom data source', 'error');
      }
    }

    // Dashboard management
    let dashboards = [];
    let currentDashboardId = null;

    async function loadDashboards() {
      if (!selectedWorkspaceId) {
        document.getElementById('dashboardsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div>Please select a workspace to view dashboards</div></div>';
        return;
      }

      try {
        const response = await fetch(`/api/dashboards/workspace/${selectedWorkspaceId}`, {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('Failed to load dashboards');
        }

        const result = await response.json();
        dashboards = result.data;

        renderDashboards();
      } catch (error) {
        console.error('Error loading dashboards:', error);
        document.getElementById('dashboardsList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><div>Failed to load dashboards</div></div>';
      }
    }

    function renderDashboards() {
      const container = document.getElementById('dashboardsList');

      if (dashboards.length === 0) {
        container.innerHTML = `
          <div class="dashboard-grid">
            <div class="dashboard-card create-dashboard-card ai-generate-card" onclick="openAIModal()">
              <div class="create-icon">AI</div>
              <div class="create-text">Generate with AI</div>
            </div>
            <div class="dashboard-card create-dashboard-card" onclick="openCreateDashboardModal()">
              <div class="create-icon">+</div>
              <div class="create-text">Create Your First Dashboard</div>
            </div>
          </div>
        `;
        return;
      }

      const dashboardsHTML = dashboards.map(dashboard => {
        const date = new Date(dashboard.created_at).toLocaleDateString();
        return `
          <div class="dashboard-card" onclick="viewDashboard('${dashboard.id}')">
            <div class="dashboard-card-header">
              <div>
                <div class="dashboard-card-title">${dashboard.name}</div>
                <div class="dashboard-card-description">${dashboard.description || 'No description'}</div>
              </div>
            </div>
            <div class="dashboard-card-footer">
              <div class="dashboard-card-date">Created ${date}</div>
              <div class="dashboard-actions" onclick="event.stopPropagation()">
                <button class="btn-icon" onclick="editDashboard('${dashboard.id}')" title="Edit">
                  ‚úèÔ∏è
                </button>
                <button class="btn-icon danger" onclick="deleteDashboard('${dashboard.id}')" title="Delete">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="dashboard-grid">
          ${dashboardsHTML}
          <div class="dashboard-card create-dashboard-card ai-generate-card" onclick="openAIModal()">
            <div class="create-icon">AI</div>
            <div class="create-text">Generate with AI</div>
          </div>
          <div class="dashboard-card create-dashboard-card" onclick="openCreateDashboardModal()">
            <div class="create-icon">+</div>
            <div class="create-text">Create New Dashboard</div>
          </div>
        </div>
      `;
    }

    function openCreateDashboardModal() {
      currentDashboardId = null;
      document.getElementById('modalTitle').textContent = 'Create New Dashboard';
      document.getElementById('dashboardName').value = '';
      document.getElementById('dashboardDescription').value = '';
      document.getElementById('dashboardModal').classList.add('show');
    }

    function editDashboard(dashboardId) {
      const dashboard = dashboards.find(d => d.id === dashboardId);
      if (!dashboard) return;

      currentDashboardId = dashboardId;
      document.getElementById('modalTitle').textContent = 'Edit Dashboard';
      document.getElementById('dashboardName').value = dashboard.name;
      document.getElementById('dashboardDescription').value = dashboard.description || '';
      document.getElementById('dashboardModal').classList.add('show');
    }

    function closeDashboardModal() {
      document.getElementById('dashboardModal').classList.remove('show');
      currentDashboardId = null;
    }

    async function saveDashboard(event) {
      event.preventDefault();

      const name = document.getElementById('dashboardName').value;
      const description = document.getElementById('dashboardDescription').value;

      try {
        const url = currentDashboardId
          ? `/api/dashboards/${currentDashboardId}`
          : '/api/dashboards';

        const method = currentDashboardId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            name,
            description,
            workspaceId: selectedWorkspaceId,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to save dashboard');
        }

        showAlert(currentDashboardId ? 'Dashboard updated successfully' : 'Dashboard created successfully', 'success');
        closeDashboardModal();
        await loadDashboards();
      } catch (error) {
        console.error('Error saving dashboard:', error);
        showAlert(error.message, 'error');
      }
    }

    async function deleteDashboard(dashboardId) {
      if (!confirm('Are you sure you want to delete this dashboard? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/dashboards/${dashboardId}`, {
          method: 'DELETE',
          credentials: 'include',
        });

        if (!response.ok) {
          throw new Error('Failed to delete dashboard');
        }

        showAlert('Dashboard deleted successfully', 'success');
        await loadDashboards();
      } catch (error) {
        console.error('Error deleting dashboard:', error);
        showAlert('Failed to delete dashboard', 'error');
      }
    }

    function viewDashboard(dashboardId) {
      // Navigate to dashboard viewer
      window.location.href = `/dashboard-viewer?id=${dashboardId}`;
    }

    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      alertContainer.appendChild(alert);

      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    // AI Dashboard Generation Functions
    async function openAIModal() {
      resetAIModal();
      document.getElementById('aiModal').classList.add('show');

      // Populate ad accounts dropdown
      const select = document.getElementById('aiAdAccount');
      select.innerHTML = '<option value="">Loading accounts...</option>';

      const workspaceId = selectedWorkspaceId || (workspaces[0] && workspaces[0].id);

      if (!workspaceId) {
        select.innerHTML = '<option value="">Select a workspace to load accounts</option>';
        return;
      }

      try {
        const response = await fetch(`/api/oauth/accounts/${workspaceId}`, {
          credentials: 'include'
        });
        const result = await response.json();

        if (result.success && result.data.length > 0) {
          select.innerHTML = result.data.map(acc =>
            `<option value="${acc.id}">${acc.account_name} (${acc.platform})</option>`
          ).join('');
        } else {
          select.innerHTML = '<option value="">No accounts connected</option>';
        }
      } catch (error) {
        select.innerHTML = '<option value="">Error loading accounts</option>';
      }
    }

    function closeAIModal() {
      document.getElementById('aiModal').classList.remove('show');
      resetAIModal();
    }

    function resetAIModal() {
      document.getElementById('aiFormSection').style.display = 'block';
      document.getElementById('aiGenerating').style.display = 'none';
      document.getElementById('aiPreviewSection').style.display = 'none';
      document.getElementById('aiPrompt').value = '';
      aiGeneratedConfig = null;
    }

    async function generateAIDashboard() {
      const prompt = document.getElementById('aiPrompt').value.trim();
      const adAccountId = document.getElementById('aiAdAccount').value;

      if (!adAccountId) {
        showAlert('Please select an ad account', 'error');
        return;
      }

      if (!prompt) {
        showAlert('Please describe what kind of dashboard you want to create', 'error');
        return;
      }

      // Show loading state
      document.getElementById('aiFormSection').style.display = 'none';
      document.getElementById('aiGenerating').style.display = 'flex';

      try {
        const response = await fetch('/api/dashboards/ai/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            prompt,
            workspaceId: selectedWorkspaceId,
            adAccountId,
            createDashboard: false,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to generate dashboard');
        }

        const result = await response.json();
        aiGeneratedConfig = result.data.config;

        // Show preview
        document.getElementById('aiGenerating').style.display = 'none';
        document.getElementById('aiPreviewSection').style.display = 'block';

        // Populate preview
        document.getElementById('aiPreviewName').textContent = aiGeneratedConfig.name;
        document.getElementById('aiPreviewDescription').textContent = aiGeneratedConfig.description;

        // Show widgets
        const widgetsHTML = aiGeneratedConfig.widgets.map(w => `
          <div class="ai-preview-item">
            <strong>${w.title}</strong> (${w.widgetType})
            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5);">Metric: ${w.metric}</div>
          </div>
        `).join('');
        document.getElementById('aiPreviewWidgets').innerHTML = widgetsHTML;

        // Show insights if available
        if (aiGeneratedConfig.insights && aiGeneratedConfig.insights.length > 0) {
          document.getElementById('aiInsights').style.display = 'block';
          const insightsHTML = aiGeneratedConfig.insights.map(i => `<li>${i}</li>`).join('');
          document.getElementById('aiInsightsList').innerHTML = insightsHTML;
        }

      } catch (error) {
        console.error('AI generation error:', error);
        showAlert(error.message, 'error');
        resetAIModal();
      }
    }

    async function createAIDashboard() {
      if (!aiGeneratedConfig) {
        showAlert('No dashboard configuration available', 'error');
        return;
      }

      // Get buttons from the preview section specifically
      const previewSection = document.getElementById('aiPreviewSection');
      const createButton = previewSection.querySelector('.btn-primary');
      const tryAgainButton = previewSection.querySelector('.btn-secondary');
      const originalText = createButton.innerHTML;

      try {
        // Disable buttons and show loading state
        createButton.disabled = true;
        tryAgainButton.disabled = true;
        createButton.innerHTML = '<span style="display: inline-flex; align-items: center; gap: 0.5rem;"><svg style="animation: spin 1s linear infinite; width: 16px; height: 16px;" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10" stroke-width="3" stroke-dasharray="31.4 31.4" stroke-linecap="round"/></svg>Creating Dashboard...</span>';

        const prompt = document.getElementById('aiPrompt').value.trim();
        const adAccountId = document.getElementById('aiAdAccount').value;

        const response = await fetch('/api/dashboards/ai/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            prompt,
            workspaceId: selectedWorkspaceId,
            adAccountId,
            createDashboard: true,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'Failed to create dashboard');
        }

        const result = await response.json();

        showAlert('AI-generated dashboard created successfully!', 'success');
        closeAIModal();
        await loadDashboards();

        // Navigate to the new dashboard
        if (result.data.dashboard && result.data.dashboard.id) {
          window.location.href = `/dashboard-viewer?id=${result.data.dashboard.id}`;
        }

      } catch (error) {
        console.error('Error creating AI dashboard:', error);
        showAlert(error.message, 'error');

        // Restore button state on error
        createButton.disabled = false;
        tryAgainButton.disabled = false;
        createButton.innerHTML = originalText;
      }
    }

    // Toggle AI Analyst Panel
    function toggleAnalystPanel() {
      const panel = document.getElementById('analystPanel');
      const toggleText = panel.querySelector('.analyst-toggle span');
      if (panel.classList.contains('expanded')) {
        panel.classList.remove('expanded');
        toggleText.textContent = 'Expand';
      } else {
        panel.classList.add('expanded');
        toggleText.textContent = 'Collapse';
      }
    }

    async function initAnalystMode() {
      const endInput = document.getElementById('analystEnd');
      const startInput = document.getElementById('analystStart');
      const today = new Date();
      endInput.value = today.toISOString().split('T')[0];
      const weekAgo = new Date(today);
      weekAgo.setDate(weekAgo.getDate() - 7);
      startInput.value = weekAgo.toISOString().split('T')[0];

      // Show debug mode only for admins or when ?debug=1 is in URL
      const urlParams = new URLSearchParams(window.location.search);
      const showDebug = urlParams.get('debug') === '1' ||
                        localStorage.getItem('enableDebugMode') === 'true' ||
                        (currentUser && currentUser.role === 'admin');
      if (showDebug) {
        document.getElementById('debugModeContainer').style.display = 'flex';
      }

      document.getElementById('analystRunBtn').addEventListener('click', runAnalystMode);
      document.getElementById('analystSource').addEventListener('change', () => {
        populateAccountSelect(document.getElementById('analystSource').value);
        updateScopePill();
        updateAnalystWarning();
        updateAnalystButtonState();
      });
      document.getElementById('analystAccount').addEventListener('change', () => {
        updateScopePill();
        updateAnalystButtonState();
      });
      ['analystQuestion', 'analystStart', 'analystEnd'].forEach((id) =>
        document.getElementById(id).addEventListener('input', updateAnalystButtonState)
      );
      ['analystKpi', 'analystCompare'].forEach((id) =>
        document.getElementById(id).addEventListener('change', updateAnalystButtonState)
      );
      document.getElementById('analystDebug').addEventListener('change', () => {
        setAnalystStatus('Idle');
      });
      populateAccountSelect('');
      updateScopePill();
      updateAnalystButtonState();
    }

    async function runAnalystMode() {
      const btn = document.getElementById('analystRunBtn');
      const question = document.getElementById('analystQuestion').value.trim();
      const start = document.getElementById('analystStart').value;
      const end = document.getElementById('analystEnd').value;
      const primaryKpi = document.getElementById('analystKpi').value;
      const compareMode = document.getElementById('analystCompare').value;
      const debug = document.getElementById('analystDebug').checked;
      if (!question || !start || !end) {
        setAnalystStatus('Please enter a question and both dates.', 'error');
        return;
      }
      const scope = getSelectedScope();
      if (!scope) {
        setAnalystStatus('Select a data source and account before running.', 'error');
        return;
      }
      const workspaceId = selectedWorkspaceId || 'workspace-main';
      btn.disabled = true;
      setAnalystStatus('Analyzing...', 'info');
      try {
        const payload = {
          workspaceId,
          question,
          dateRange: { start, end },
          compareMode,
          primaryKpi,
          debug,
          scope,
        };
        const response = await postJSON('/api/ai/analyze', payload);
        const finalResponse = response.result || response;
        const trace = response.trace || null;
        renderAnalystResults(finalResponse, trace);
        setAnalystStatus('Analysis complete.', 'success');
      } catch (error) {
        setAnalystStatus(error.message || 'Analysis failed.', 'error');
      } finally {
        btn.disabled = false;
      }
    }

    function renderAnalystResults(finalResponse, trace) {
      if (!finalResponse) return;
      const resultsEl = document.getElementById('analystResults');
      document.getElementById('analystExecHeadline').textContent = finalResponse.exec_summary?.headline || 'No headline available';
      document.getElementById('analystExecWhatChanged').innerHTML = renderList(finalResponse.exec_summary?.what_changed || []);
      document.getElementById('analystExecWhy').innerHTML = renderList(finalResponse.exec_summary?.why || []);
      document.getElementById('analystExecNext').innerHTML = renderList(finalResponse.exec_summary?.what_to_do_next || []);
      document.getElementById('analystFindingsList').innerHTML = renderFindings(finalResponse.findings || []);
      document.getElementById('analystActionsList').innerHTML = renderActions(finalResponse.actions || []);
      document.getElementById('analystEvidenceList').innerHTML = renderEvidence(finalResponse.evidence || []);
      const traceSection = document.getElementById('analystTraceSection');
      if (trace && (Array.isArray(trace.plan_steps) || Array.isArray(trace.tool_calls))) {
        traceSection.style.display = 'block';
        document.getElementById('analystTraceContent').innerHTML = renderTrace(trace);
      } else {
        traceSection.style.display = 'none';
      }
      resultsEl.style.display = 'block';
    }

    function getSelectedScope() {
      const source = document.getElementById('analystSource').value;
      if (!source) return null;
      const accountSelect = document.getElementById('analystAccount');
      const option = accountSelect.selectedOptions[0];
      if (!option || !accountSelect.value) return null;
      const entityLevel = document.getElementById('analystEntityLevel').value;
      const scope = { source, entityLevel };
      if (source === 'meta_ads' || source === 'custom_data') {
        scope.accountId = accountSelect.value;
      }
      if (source === 'search_console') {
        scope.propertyUrl = option.dataset.propertyUrl || accountSelect.value;
      }
      return scope;
    }

    function populateAccountSelect(source) {
      const select = document.getElementById('analystAccount');
      if (!select) return;
      select.innerHTML = '<option value="">Select account</option>';
      if (!source) {
        select.disabled = true;
        return;
      }
      const list =
        source === 'meta_ads'
          ? analystAccountsBySource.meta_ads
          : source === 'search_console'
            ? analystAccountsBySource.search_console
            : source === 'custom_data'
              ? analystCustomSources
              : [];
      if (!list.length) {
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.disabled = true;
        placeholder.textContent = source === 'custom_data' ? 'No custom data sources' : 'No accounts connected';
        select.appendChild(placeholder);
        select.disabled = true;
        return;
      }
      list.forEach((item) => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.label;
        option.dataset.label = item.label;
        if (item.propertyUrl) {
          option.dataset.propertyUrl = item.propertyUrl;
        }
        select.appendChild(option);
      });
      select.disabled = false;
    }

    function updateScopePill() {
      const pill = document.getElementById('analystScopePill');
      const source = document.getElementById('analystSource').value;
      const accountSelect = document.getElementById('analystAccount');
      const option = accountSelect.selectedOptions[0];
      if (!source || !option || !accountSelect.value) {
        pill.style.display = 'none';
        return;
      }
      const label = option.dataset.label || option.textContent;
      pill.textContent = `Analyzing: ${sourceLabel(source)} ‚Ä¢ ${label}`;
      pill.style.display = 'inline-flex';
    }

    function sourceLabel(value) {
      if (value === 'meta_ads') return 'Meta Ads';
      if (value === 'search_console') return 'Search Console';
      if (value === 'custom_data') return 'Custom data';
      return value;
    }

    function isDateRangeValid(start, end) {
      if (!start || !end) return false;
      const startDate = new Date(start);
      const endDate = new Date(end);
      return startDate <= endDate;
    }

    function updateAnalystButtonState() {
      const btn = document.getElementById('analystRunBtn');
      if (!btn) return;
      btn.disabled = !isAnalystReady();
    }

    function isAnalystReady() {
      const question = document.getElementById('analystQuestion').value.trim();
      const start = document.getElementById('analystStart').value;
      const end = document.getElementById('analystEnd').value;
      const source = document.getElementById('analystSource').value;
      const accountValue = document.getElementById('analystAccount').value;
      if (!question || !start || !end || !isDateRangeValid(start, end) || !source) {
        return false;
      }
      if (source === 'custom_data') {
        return accountValue.length > 0;
      }
      return accountValue.length > 0;
    }

    function updateAnalystWarning() {
      const warning = document.getElementById('analystScopeWarning');
      if (!warning) return;
      const showWarning = (!hasAnalystAccounts() || analystNoDataBannerVisible) && !isAnalystScopeCustomDataSelected();
      warning.style.display = showWarning ? 'block' : 'none';
    }

    function hasAnalystAccounts() {
      return analystAccountsBySource.meta_ads.length > 0 || analystAccountsBySource.search_console.length > 0;
    }

    function isAnalystScopeCustomDataSelected() {
      return document.getElementById('analystSource').value === 'custom_data' &&
        !!document.getElementById('analystAccount').value;
    }

    function attachAccountClickHandlers() {
      document.querySelectorAll('.account-item').forEach((item) => {
        item.addEventListener('click', (event) => {
          if (event.target.closest('.account-actions')) return;
          handleAccountSelection(item);
        });
      });
    }

    function handleAccountSelection(accountEl) {
      if (!accountEl) return;
      document.querySelectorAll('.account-item.active').forEach((el) => el.classList.remove('active'));
      accountEl.classList.add('active');
      const source = accountEl.dataset.source || '';
      const value = accountEl.dataset.accountValue || '';
      document.getElementById('analystSource').value = source;
      populateAccountSelect(source);
      const accountSelect = document.getElementById('analystAccount');
      if (accountSelect) {
        accountSelect.value = value;
      }
      updateScopePill();
      updateAnalystWarning();
      updateAnalystButtonState();
      document.querySelector('.analyst-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderFindings(items) {
      if (!items.length) {
        return '<p style="color:rgba(255,255,255,0.6); font-size:0.85rem;">No findings returned.</p>';
      }
      return items.map(item => `
        <div class="analyst-evidence-item">
          <strong>${escapeHTML(item.title || 'Finding')}</strong>
          <p>${escapeHTML(item.detail || '')}</p>
          <p style="font-size:0.8rem; color:rgba(255,255,255,0.6);">${escapeHTML(item.impact || '')}</p>
          <div class="metric-tags">${renderTags(item.supporting_metrics || [])}</div>
        </div>
      `).join('');
    }

    function renderActions(items) {
      if (!items.length) {
        return '<p style="color:rgba(255,255,255,0.6); font-size:0.85rem;">No actions returned.</p>';
      }
      const priorityOrder = { high: 1, medium: 2, low: 3 };
      items.sort((a, b) => (priorityOrder[a.priority] || 4) - (priorityOrder[b.priority] || 4));
      return items.map(item => `
        <div class="analyst-evidence-item">
          <strong>${escapeHTML(item.action || 'Action')}</strong>
          <p>${escapeHTML(item.rationale || '')}</p>
          <p style="font-size:0.8rem; color:rgba(255,255,255,0.6);">Impact: ${escapeHTML(item.expected_impact || 'N/A')}</p>
          <p style="font-size:0.8rem; color:rgba(255,255,255,0.6);">How to validate: ${escapeHTML(item.how_to_validate || 'N/A')}</p>
          <div class="metric-tags">${renderTags(item.supporting_metrics || [])}</div>
        </div>
      `).join('');
    }

    function renderEvidence(items) {
      if (!items.length) {
        return '<p style="color:rgba(255,255,255,0.6); font-size:0.85rem;">No evidence items.</p>';
      }
      return items.map(item => `
        <div class="analyst-evidence-item">
          <div style="font-size:0.85rem; color:rgba(255,255,255,0.5); margin-bottom:0.4rem;">
            <strong>${escapeHTML(item.tool || 'tool')}</strong> ¬∑ ${escapeHTML(item.params_summary || '')}
          </div>
          <ul style="margin:0; padding-left:1.25rem;">
            ${item.key_results?.map(result => `<li style="font-size:0.8rem; color:rgba(255,255,255,0.7);">${escapeHTML(result)}</li>`).join('') || ''}
          </ul>
        </div>
      `).join('');
    }

    function renderTrace(trace) {
      const plan = trace.plan_steps || [];
      const planList = plan.length ? `<div><strong>Plan:</strong><ul>${renderList(plan)}</ul></div>` : '';
      const toolCalls = trace.tool_calls || [];
      const toolHtml = toolCalls.map(call => `
        <div class="trace-item">
          <strong>${escapeHTML(call.name || 'tool call')}</strong>: ${escapeHTML(call.args_summary || '')}
          <div style="font-size:0.8rem; color:rgba(255,255,255,0.6);">Result: ${escapeHTML(call.result_summary || '')}</div>
        </div>
      `).join('');
      return `${planList}<div class="trace-list">${toolHtml}</div>`;
    }

    function setAnalystStatus(message, variant = 'info') {
      const status = document.getElementById('analystStatus');
      status.textContent = message;
      status.classList.toggle('error', variant === 'error');
    }

    async function postJSON(url, body) {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body),
      });
      if (!response.ok) {
        let message = 'Request failed';
        try {
          const payload = await response.json();
          message = payload.message || message;
        } catch (error) {
          message = response.statusText || message;
        }
        throw new Error(message);
      }
      return response.json();
    }

    function renderList(items) {
      return items.map(item => `<li>${escapeHTML(item)}</li>`).join('');
    }

    function renderTags(metrics) {
      if (!metrics.length) return '';
      return metrics.map(metric => `<span class="metric-tag">${escapeHTML(metric)}</span>`).join('');
    }

    function escapeHTML(value) {
      if (!value) return '';
      return value.toString().replace(/[&<>"']/g, tag => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[tag]));
    }

    async function logout() {
      // Get token before clearing
      const token = localStorage.getItem('token');

      // Clear localStorage FIRST to prevent race conditions
      localStorage.removeItem('token');
      localStorage.removeItem('user');

      try {
        // Call logout API to clear server-side cookie
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
      } catch (error) {
        console.error('Logout API error:', error);
      }

      // Redirect with logout parameter to skip auth check
      window.location.href = '/login?logout=true';
    }
  </script>
</body>
</html>
